---
title: "Elasticsearch Sık Kullanılan Komutlar"
description: 'Elasticsearch Sık Kullanılan Komutlar'
---

*   *   *   *   * 

  * [Apinizer Dokümantasyonu](/apinizer-dokumantasyonu/apinizer-dokuemantasyonuna-hos-geldiniz-1179695.html)
  * [Sorun Giderme](/apinizer-dokumantasyonu/sorun-giderme-6685033.html)
  * Current: Elasticsearch Sık Kullanılan Komutlar

# Elasticsearch Sık Kullanılan Komutlar

![](/apinizer-dokumantasyonu/_/05BD9F48017A5D1E2319A7812864C3E5/1699865923290/images/common/warning-macro-icon.svg)

Production ortamlarında veriye doğrudan müdahale edilmesi hiçbir zaman önerilmemektedir.  
Production ortamlarında yapılacak her türlü işlem veya değişiklik öncesinde, ilgili adımların mutlaka test ortamında denenmesi ve sistemin güncel yedeğinin alınması gerekmektedir.

# İndeks Görme ve Silme

## Doküman Sayısını Görme
```bash
    curl -X GET "&#60;ELASTICSEARCH_IP&#62;:9200/&#60;INDEX_KEY&#62;/_doc/_count"
```

BASH

## Where Koşullu İndeks Görme
```bash
    curl -X GET "&#60;ELASTICSEARCH_IP&#62;:9200/*/_search?pretty=true&q=apn:XYS"
```


```bash
    curl -X GET "&#60;ELASTICSEARCH_IP&#62;:9200/_search?pretty" -H 'Content-Type: application/json' -d'
    &#123;
      "query": &#123;
        "bool": &#123;
          "must": [
            &#123;
              "match": {
                "apn": "TEST GW"
              &#125;
            &#125;,
            &#123;
              "range": {
                "created": {
                  "gte": "now-7d/d",
                  "lt": "now-5d/d"
                &#125;}}]}}}'
```


```bash
    curl -X GET "&#60;ELASTICSEARCH_IP&#62;:9200/_search?pretty" -H 'Content-Type: application/json' -d'
    &#123;
        "_source": ["contentType"],   
        "size": 50,
        "query": &#123;
            "match_all": {}
        &#125;}'
```



## Requestteki CID ile Responsedaki CID Aynı Olmayan Kayıtları Script ile Bulan Sorgu
```bash
    curl -X GET "&#60;ELASTICSEARCH_IP&#62;:9200/_search?pretty" -H 'Content-Type: application/json' -d'
    &#123;
        "query": &#123;
            "bool": &#123;
                "filter": [
                    &#123;
                        "script": {
                            "script": {
                                "source": "doc['headerRequestFromClient.APINIZER-CORRELATION-ID.keyword'].value !=  doc['headerResponseToClient.APINIZER-CORRELATION-ID.keyword'].value",
                                "lang": "painless"
                            &#125;}},
                    &#123;
                        "range": {
                            "created": {                            
                              "gte": "2021-06-28T16:30:32.000"                           
                            &#125;}},
    				&#123;
    				  "term":{
    					"instanceId":2
    				  &#125;}]}}}'
```



  

## Belirli Zaman Aralığında Saniye Bazlı Gelen Requestlerin Listesi
```bash
    curl -X GET "&#60;ELASTICSEARCH_IP&#62;:9200/_search?pretty" -H 'Content-Type: application/json' -d'
    &#123;
      "query": &#123;
         "bool": &#123;
          "filter": [
            &#123;
              "match": {
                "api": "64bc02787cd66f332a3ad235"
              &#125;},
            &#123;
              "range": {
                "created": {
                  "gte": "2020-06-08T15:08:00.000",
                  "lte": "2020-06-08T15:12:00.000"
                &#125;}}]}},   
        "aggs" : {
            "reqs_over_time" : {
                "date_histogram" : {
                    "field" : "created",
                    "interval" : "1s"
                &#125;}}}'
```



  

## Correlation ID'ye Göre Belirli Dokümanları Bulma
```bash
    curl -X GET "&#60;ELASTICSEARCH_IP&#62;:9200/_search?pretty" -H 'Content-Type: application/json' -d' { "query" : { "match":{ "aci": "c3d8523e-e3ac-497b-ac7a-76853198c239" }}}'
```

BASH

  

## İndeks Adına Göre Silme
```bash
    curl -X DELETE "&#60;ELASTICSEARCH_IP&#62;:9200/&#60;INDEX_KEY&#62;"
```

BASH

  

## Verilen Kelimenin Geçtiği İndeksleri Silme
```bash
    curl -X DELETE "&#60;ELASTICSEARCH_IP&#62;:9200/*metric*"
```

BASH

  

# Elasticsearch Yığınının Read_Only Durumunu Değiştirmek
```bash
    curl -X PUT "&#60;ELASTICSEARCH_IP&#62;:9200/_all/_settings?wait_for_completion=false" -H "Content-Type: application/json"  -d'
    &#123;
        "index.blocks.read_only_allow_delete": null,
        "index.blocks.write": null
    &#125;'
```

BASH

Sadece bir indeks için:
```bash
    curl -X PUT "&#60;ELASTICSEARCH_IP&#62;:9200/&#60;INDEX_KEY&#62;/_settings?pretty" -H 'Content-Type: application/json' -d'
    &#123;
        "index.blocks.read_only_allow_delete": null,
    	"index.blocks.write": null
    &#125;'
```

BASH

  

# Rollover ile Yeni İndekse Geçme
```bash
    http://&#60;ELASTICSEARCH_IP&#62;:9200/apinizer-log-apiproxy-&#60;INDEX_KEY&#62;/_rollover
```

BASH

  

# Arama (Search)

## Belirli Indeksteki Dokümanları Sorgulama
```bash
    curl -X GET "&#60;ELASTICSEARCH_IP&#62;:9200/&#60;INDEX_KEY&#62;/_search?pretty=true&q=*:*"
```

BASH

  

## Belirli Kritere Göre Indeksteki Dokümanları Sorgulama
```bash
    curl -X GET "&#60;ELASTICSEARCH_IP&#62;:9200/*/_search?pretty=true&q=apn:Petstore+API"
```

BASH

  

## Belirli Zaman Aralığına Göre Dokümanları Sorgulama
```bash
    curl -X GET "&#60;ELASTICSEARCH_IP&#62;:9200/_search?pretty" -H 'Content-Type: application/json' -d
    '{
      "query": &#123;
        "bool": &#123;
          "must": [
            &#123;
              "match": {
                "apn": "Petstore API"
              &#125;
            &#125;,
            &#123;
              "range": {
                "created": {
                  "gte": "now-7d/d",
                  "lt": "now-5d/d"
                &#125;
              &#125;
            &#125;
          ]
        &#125;
      &#125;
    &#125;'
```

BASH

  

## Belirli Kriterlere Göre Doküman Sonuçlarını Aggregate Etme
```bash
    curl -X GET "&#60;ELASTICSEARCH_IP&#62;:9200/_search?pretty" -H 'Content-Type: application/json' -d
    '{
      "query": &#123;
         "bool": &#123;
          "filter": [
            &#123;
              "match": {
                "api": "64bc02787cd66f332a3ad235"
              &#125;
            &#125;,
            &#123;
              "range": {
                "created": {
                  "gte": "2020-06-08T15:08:00.000",
                  "lte": "2020-06-08T15:12:00.000"
                &#125;
              &#125;
            &#125;
          ]
    	&#125;    
      &#125;, 	
    	"aggs" : {
            "reqs_over_time" : {
                "date_histogram" : {
                    "field" : "created",
                    "interval" : "1s"
                &#125;
            &#125;
        &#125;
    &#125;'
```

BASH

## Son 1 Günde, Her Bir Yetkili Kullanıcının, Her Bir Api Proxy'e Attığı İsteklerin Sayısını Bulma
```bash
    curl -X GET "&#60;ELASTICSEARCH_IP&#62;:9200/&#60;INDEX_KEY&#62;/_search?pretty" -H 'Content-Type: application/json' -d'
    &#123;
      "size": 0,
      "query": &#123;
        "range": {
           "@timestamp": { 
    			"gte": "now/d",
    			"lt": "now+1d/d"
    		&#125;
        &#125;
      &#125;,
      "aggs": {
        "by_uok": {
          "terms": { "field": "uok", "size": 1000 },
          "aggs": {
            "by_apn": {
              "terms": {
                "field": "apn",
                "size": 1000,
                "missing": "BelirliBirApiProxyeGitmeyenler"
              &#125;
            &#125;
          &#125;
        &#125;
      &#125;
    &#125;
```

BASH

# Güncelleme (Update)

## Dokümanı Güncelleme
```bash
    curl -X PUT "&#60;ELASTICSEARCH_IP&#62;:9200/&#60;INDEX_KEY&#62;/doc/1?pretty&pretty" -H 'Content-Type: application/json' -d'
    &#123;
      "name": "John Doe"
    &#125;'
```

BASH

##   
Belirlenen Alanlardan Spesifik Bir Elementi Silme
```bash
    curl -X POST "&#60;ELASTICSEARCH_IP&#62;:9200/_update_by_query?pretty" -H 'Content-Type: application/json' -d'
    &#123;
      "script" : 
    	"ctx._source.headerRequestFromClient.remove('header-name-1');
    	 ctx._source.headerRequestToTarget.remove('header-name-2');",
      "query": &#123; "match_all": {} }
    &#125;
```

BASH

  

## Kriterlere Göre Belirli Değerleri Silme
```bash
    curl -X  POST "&#60;ELASTICSEARCH_IP&#62;:9200/*/_update_by_query?pretty&conflicts=proceed&requests_per_second=200" -H 'Content-Type: application/json' -d'
    &#123;
      "query": &#123;
        "bool" : {
          "filter": {
            "exists": {
                "field": "headerRequestFromClient.user_username"
              &#125;
          &#125;,
          "must_not" : {
           "term": {
              "headerRequestFromClient.user_password": ""
            &#125;
          &#125;
        &#125;
      &#125;,
      "script":  "ctx._source.headerRequestFromClient.remove(\"user_password\");"
    &#125;
```

BASH

![](/apinizer-dokumantasyonu/_/05BD9F48017A5D1E2319A7812864C3E5/1699865923290/images/common/info-macro-icon.svg)

  * _Execution Reject_ hatası, requests_per_second anahtarının değeriyle önlenecektir.
  * Toplu İşlem Boyutu varsayılan olarak 1000'dir. İki istek arasındaki bekleme süresi 5 (=1000/200) verilerek ayarlanır.

```bash
     http://&#60;ELASTICSEARCH_IP&#62;:9200/*/_update_by_query?conflicts=proceed&wait_for_completion=true
    &#123;
      "script": {
        "inline": 
    	"ctx._source.remove('apmi');
    	 ctx._source.remove('tba');
    	 ctx._source.remove('tcb');
    	 ctx._source.remove('fbarb');
    	 ctx._source.remove('tbah');
    	 ctx._source.remove('fbarh');
    	 ctx._source.remove('tch');",
        "lang": "painless"
      &#125;,
      "query": &#123;
        "bool": &#123;
          "must": [
            &#123;
              "range": {
                "created": {
                 "gte": "2019-02-01T20:03:12.963",
                  "lte": "2019-04-30T20:03:12.963"
                &#125;
              &#125;
            &#125;
          ],
          "adjust_pure_negative": true,
          "boost": 1
        &#125;
      &#125;
    &#125;
```

BASH

  

## Belirli Bir Rest Uç Adrese Ait Loglardan Yanıt Body Alanlarının Silinmesi

![](/apinizer-dokumantasyonu/_/05BD9F48017A5D1E2319A7812864C3E5/1699865923290/images/common/note-macro-icon.svg)

Bu uç adres openapi ya da no-spec cinsinde bir API proxy içerisinde olarak tanımlı olmalı. Birden fazla serviste aynı uç adres varsa sorguya api proxy ismi de eklenmelidir
```bash
    curl --location --request POST 'http://&#60;ELASTICSEARCH_IP&#62;:9200/&#60;INDEX_KEY&#62;/_update_by_query?pretty'  --header 'Content-Type:application/json'  --data-raw '{
      "script": {
        "source": "ctx._source.remove('tcb');ctx._source.remove('fbarb')",
        "lang": "painless"
      &#125;,
      "query": &#123;
        "term": {
          "apmn": "/anApiProxyEndpoint"
        &#125;
      &#125;
    &#125;
    '
```

BASH

  

## Belirli Bir Tarihe Kadar Olan Loglardan Bazı Body Alanlarının Silinmesi
```bash
    curl -X POST "&#60;ELASTICSEARCH_IP&#62;:9200/.ds-apinizer-log-apiproxy-&#60;LOG_KEY&#62;-000*/_update_by_query?pretty" -H 'Content-Type: application/json' -d '
    &#123;
      "query": &#123;
        "bool": &#123;
          "filter": [
            &#123;
              "range": {
                "@timestamp": {
                  "lte": "2024-04-20T00:00:00.000Z" 
                &#125;
              &#125;
           &#125;
          ]
        &#125;
      &#125;,
      "script": {
        "source": "ctx._source.remove(\"tba\"); ctx._source.remove(\"fbarb\"); ctx._source.remove(\"tcb\")"
      &#125;
    &#125;'
```

BASH

![](/apinizer-dokumantasyonu/_/05BD9F48017A5D1E2319A7812864C3E5/1699865923290/images/common/note-macro-icon.svg)

Tarih yerine Api Proxy id değerine göre güncelleme yapmak isterseniz "range": &#123; "@timestamp": &#123; "lte": "2024-04-20T00:00:00.000Z" &#125; &#125; kısmı yerine "match": &#123; "api": "64ac03067e8f7400cf4adbdd" &#125; filtresini ekleyebilirsiniz.

![](/apinizer-dokumantasyonu/_/05BD9F48017A5D1E2319A7812864C3E5/1699865923290/images/common/note-macro-icon.svg)

Elasticsearch veri yapısını incelemek ve silinecek alanları belirlemek için şu adrese gidiniz: [API Trafiği Log Kaydı Veri Yapısı](/apinizer-dokumantasyonu/api-trafigi-log-kaydi-veri-yapisi-39742573.html).

# Replica Sayısı Ayarlama
```bash
     curl -X PUT "&#60;ELASTICSEARCH_IP&#62;:9200/_template/template_genel?pretty" -H 'Content-Type: application/json' -d'
    &#123;
      "index_patterns": ["*log*", "*metric*", "*db*"],
      "settings": {
        "number_of_shards": 1,
    	"number_of_replicas": 0
      &#125; 
    &#125;
    '  
```

BASH
```bash
    curl -XPUT '&#60;ELASTICSEARCH_IP&#62;:9200/*/_settings' -H 'Content-Type: application/json' -d'
    &#123;
    	"index" : {            
    		"number_of_replicas" : 0
    	&#125;    
    &#125;'
```

BASH

# Shard Allocation
```bash
    curl -X PUT "&#60;ELASTICSEARCH_IP&#62;:9200/_cluster/settings" -H 'Content-Type: application/json' -d'
    &#123;
        "transient" : {
            "cluster.routing.allocation.enable" : "all"
        &#125;
    &#125;'
```

BASH

# Shard Limiti Arttırma
```bash
    curl -X PUT "http://&#60;ELASTICSEARCH_IP&#62;:9200/_cluster/settings" -H 'Content-Type: application/json' -d'{
      "persistent" : {
        "cluster.routing.allocation.total_shards_per_node" : 2000 ,
        "cluster.max_shards_per_node":2000
      &#125;
    &#125;'
```

BASH

# Log Seviyesi Değiştirme
```bash
    curl -X PUT "&#60;ELASTICSEARCH_IP&#62;:9200/_cluster/settings" -H 'Content-Type: application/json' -d'{"transient":{"logger._root":"DEBUG"}}'
    curl -X PUT "&#60;ELASTICSEARCH_IP&#62;:9200/_cluster/settings" -H 'Content-Type: application/json' -d'{"transient":{"logger._root":"INFO"}}'
```

BASH

  

# ShowLog Ayarları
```bash
    curl -X PUT "&#60;ELASTICSEARCH_IP&#62;:9200/*log*/_settings?pretty" -H 'Content-Type: application/json' -d'
    &#123;
        "index.search.slowlog.threshold.fetch.trace": "200ms",
        "index.search.slowlog.level": "trace"
    &#125;'
```

BASH

  

# Elasticsearch Shard ve Replikasyon Yönetimi

### Shard Tahsisini Etkinleştirme:
```bash
    curl -XPUT '&#60;ELASTICSEARCH_IP&#62;:9200/_cluster/settings' -d '{
        "transient" : {
            "cluster.routing.allocation.enable" : "all"
        &#125;
    &#125;' --header 'Content-Type:application/json'
```

BASH

### Başarısız Shard'ları Yeniden Deneme:
```bash
    curl -XPOST '&#60;ELASTICSEARCH_IP&#62;:9200/_cluster/reroute?retry_failed'  --header 'Content-Type:application/json'
```

BASH

### Küme Tahsis Açıklamasını Sorgulama:
```bash
    curl -XGET '&#60;ELASTICSEARCH_IP&#62;:9200/_cluster/allocation/explain?pretty'
```

BASH

### İndeks Replikasyon Ayarlarını Güncelleme:
```bash
    curl -XPUT '&#60;ELASTICSEARCH_IP&#62;:9200/_settings' -d '
    &#123;
        "index" : {
            "number_of_replicas" : 0
        &#125;
    &#125;'  --header 'Content-Type:application/json'
```

BASH

# Diğer

### _cat APIs
```bash
    curl -X GET "&#60;ELASTICSEARCH_IP&#62;:9200/_cat/indices/*?v&s=index&pretty"
    
    curl -X GET "&#60;ELASTICSEARCH_IP&#62;:9200/_cat/thread_pool?v&h=id,node_name,ip,name,core,queue,rejected,completed,max"
```

BASH

### _nodes APIs
```bash
    curl -X GET "&#60;ELASTICSEARCH_IP&#62;:9200/_nodes/os?pretty"
    
    curl -X GET "&#60;ELASTICSEARCH_IP&#62;:9200/_nodes/jvm?pretty"
    
    curl -X GET "&#60;ELASTICSEARCH_IP&#62;:9200/_nodes/thread_pool?pretty"
    
    curl -X GET "&#60;ELASTICSEARCH_IP&#62;:9200/_nodes/stats/process?filter_path=**.max_file_descriptors"
```

BASH

### _cluster APIs
```bash
    curl -X GET "&#60;ELASTICSEARCH_IP&#62;:9200/_cluster/stats?pretty"
    
    curl -XGET '&#60;ELASTICSEARCH_IP&#62;:9200/_cluster/state?pretty=true' > result.json
```

BASH

### Flush
```bash
    curl -X POST "&#60;ELASTICSEARCH_IP&#62;:9200/*log*/_flush/synced?pretty"
```

BASH

### Log yazım engelinin kaldırılması
```bash
    curl -XPUT 'http://&#60;ELASTICSEARCH_IP&#62;:9200/*log*/_settings' -H 'Content-Type: application/json' -d'{"index": {"blocks": {"read_only_allow_delete": null}}}'
```

BASH

### Snapshota ait genel bilgiler
```bash
    curl 'http://&#60;ELASTICSEARCH_IP&#62;:9200/_snapshot?pretty'
```

BASH

### Repository ve snapshot detayları
```bash
    curl 'http://&#60;ELASTICSEARCH_IP&#62;:9200/_slm/policy/apinizer-slm-policy-&#60;INDEX_KEY&#62;?pretty' 
```

BASH

### Önceki komuttan alınan repository ve snapshot isimleri ile detaylı inceleme
```bash
    curl -XGET "http://&#60;ELASTICSEARCH_IP&#62;:9200/_snapshot/apinizer-repository-&#60;INDEX_KEY&#62;/apinizer-snapshot-&#60;INDEX_KEY&#62;-2023.03.13-m33h8zcpq_if4swyzn0wrq?pretty"
    
    curl -XGET "http://&#60;ELASTICSEARCH_IP&#62;:9200/_snapshot/apinizer-repository-&#60;INDEX_KEY&#62;/apinizer-snapshot-&#60;INDEX_KEY&#62;-2023.03.13-m33h8zcpq_if4swyzn0wrq/_status?pretty"
```

BASH

### Snapshot ile ilgili tüm ayarların silinmesi
```bash
    curl -XDELETE 'http://&#60;ELASTICSEARCH_IP&#62;:9200/_snapshot/apinizer-repository-&#60;INDEX_KEY&#62;?pretty'
```

BASH

×