---
title: "Elasticsearch Olası Sorunları ve Çözümleri"
description: 'Elasticsearch Olası Sorunları ve Çözümleri'
---

*   *   *   *   * 

  * [Apinizer Dokümantasyonu](/apinizer-dokumantasyonu/apinizer-dokuemantasyonuna-hos-geldiniz-1179695.html)
  * [Sorun Giderme](/apinizer-dokumantasyonu/sorun-giderme-6685033.html)
  * Current: Elasticsearch Olası Sorunları ve Çözümleri

# Elasticsearch Olası Sorunları ve Çözümleri

  

Problem| 

### Elasticsearch sunucularındaki disk doluluğu nedeniyle Elasticsearch'ün log yazımını durdurması  
  
---|---  
Sebep/Neden| Elasticsearch varsayılan ayarlarıyla kurulduğunda, bulunduğu disk %85 doluluk oranına ulaştığında uyarı verir ve %90'a geldiğinde log yazımını durdurur.  
Çözüm| Diskte yer açılması ya da diskin büyütülmesi gerekmektedir. Bu işlem sonrasında aşağıdaki komut ile diskin tekrar yazıma hazır olduğu bildirilmelidir.`curl -X PUT ``"&#60;ELASTIC_IP&#62;:9200/_all/_settings?pretty"` `-H ``'Content-Type: application/json'` `-d'`  
`{`  
` ``"index.blocks.read_only_allow_delete"``: null`  
`}'`  
Ek Öneri| Bu durum büyük disklerde miktar olarak yüksek alanların kullanılamamasına yol açabildiğinden sunucularına özel ayarlanması tavsiye edilmektedir. Bu limitler yüzdesel ya da direk sayısal olarak disk boyutu verilerek güncellenebilir.  
Disk boyutu sayısal limitle ayarlama:`curl -X PUT ``"`&#60;ELASTIC_IP&#62;`:9200/_cluster/settings"` `-H ``'Content-Type: application/json'` `-d``'`  
`{`  
` ``"transient": {`  
` ``"cluster.routing.allocation.disk.watermark.low": "100gb",`  
` ``"cluster.routing.allocation.disk.watermark.high": "80gb",`  
` ``"cluster.routing.allocation.disk.watermark.flood_stage": "50gb",`  
` ``"cluster.info.update.interval": "1m"`  
`}}'`  
Disk boyutunu yüzdesel limitle ayarlama:`curl -X PUT ``"`&#60;ELASTIC_IP&#62;`:9200/_cluster/settings"` `-H ``'Content-Type: application/json'` `-d``'`  
`{`  
` ``"transient": {`  
` ``"cluster.routing.allocation.disk.watermark.low": "`90%`",`  
` ``"cluster.routing.allocation.disk.watermark.high": "`93%`",`  
` ``"cluster.routing.allocation.disk.watermark.flood_stage": "9`5%`",`  
` ``"cluster.info.update.interval": "1m"`  
`}}'`  
`#Sonrasında anlık çalışmaya devam ettirdiğiniz Elasticsearch'ün konfigürasyon dosyasına da aynı değerleri girmelisiniz. Bu uygulamanın olası bir restart durumunda ayarlarınızın kaybolmaması için gereklidir.`  

[code]
    cluster.routing.allocation.disk.threshold_enabled: true
    cluster.routing.allocation.disk.watermark.low: 93%
    cluster.routing.allocation.disk.watermark.high: 95%
[/code]  
  
  

Problem| 

### Kibana'da log aramalarında alınabilen "x of y shards failed: The data you are seeing might be incomplete or wrong. The length of [X] field of [Y] doc of [&#60;INDEX_NAME&#62;] index has exceeded [1000000] - maximum allowed to be analyzed for highlighting" hatası  
  
---|---  
Sebep/Neden| Elasticsearch'ün her bir kayıt için highlight işlemini yapabileceği veri büyüklüğü limiti varsayılan olarak 1.000.000 karakter olarak gelmektedir. Elasticsearch'ün JVM RAM kullanımı ve arama hızı için belirlediği optimal değer bu şekildedir.  
Çözüm| Bu ayar aşağıdaki komut yardımıyla yükseltilebilir. Bu değeri, eğer veri boyutunuzu bilmiyorsanız, azar miktarda arttırarak verilerinize uygun limite ayarlamanız tavsiye edilir.curl -XPUT "`&#60;ELASTIC_IP&#62;`:9200/.ds-apinizer-log-apiproxy-AAAA-000*/_settings" -H "Content-Type: application/json" -d'&#123; "index" : &#123; "highlight.max_analyzed_offset" : 2000000 &#125;&#125;'  
  
  

Problem| 

### Api Trafik ekranlarında "Request cannot be executed; I/O reactor status: STOPPED" uyarısı ile logların görünmemesi  
  
---|---  
Sebep/Neden| Elasticsearch'ün kullandığı ram limitlerinin yükseltilmesi gereklidir.  
Çözüm| Bu ayar jvm.options dosyasından yükseltilebilinir. Toplam ram miktarının yarısını aşmaması tavsiye edilir.sudo vi /opt/elasticsearch/elasticsearch-7.9.2/config/jvm.options-Xms8g  
-Xmx8gsystemctl restart elasticsearch  
  
  

Problem| 

### Elasticsearch exception [type=validation_exception, reason=Validation Failed: 1: this action would add [2] total shards, but this cluster currently has [1000]/[1000] maximum shards open;]  
  
---|---  
Sebep/Neden|  You are reaching the limit **_cluster.max_shards_per_node_**. Add more data node, reduce the number of shards in cluster or increase the shard limit on the system.  
Çözüm| Bu sorunun doğru çözümü veri tutan node sayısını arttırmaktır.  
Alternatif Çözüm| Data node'ları artırmak her zaman mümkün olmayabileceğinden, shard'ların manuel olarak yönetilmesi de kullanılabilir bir çözümdür. Bunun için aşağıdaki komutlar kullanılabilir.  
curl -XPUT http://&#60;ELASTICSEARCH_IP&#62;:9200/_cluster/settings --header "Content-Type:application/json" -d '&#123;  
"persistent" : &#123;  
"cluster.routing.allocation.total_shards_per_node" : 2000 ,  
"cluster.max_shards_per_node":2000  
}  
}'curl http://&#60;ELASTICSEARCH_IP&#62;:9200/apinizer-log-apiproxy-&#60;INDEX_KEY&#62;/_rollover  
Alternatif Çözüm| Önceki çözümlerin ikisi de kullanılabilir değilse, en son çare eski dizinleri temizlemek/silmektir. Bu yöntem eski loglarda kayba neden olacağından **ÖNERİLMEMEKTEDİR.** curl -XDELETE http://&#60;ELASTICSEARCH_IP&#62;:9200/apinizer-log-apiproxy-&#60;INDEX_KEY&#62;-&#60;INDEX_NUMBER&#62;/_rollover  
  
  

Problem| 

### Unassigned Shards - CLUSTER-RECOVERED  
  
---|---  
Sebep/Neden| Shard dağıtımını olası bir sunucu restart'ı ya da dosya kaybı sonrasında yapamıyor olabilir.  
Çözüm| Bu sorunun birden fazla çözümü olabilir. Tüm elasticsearch node'larının çalıştığından ve dosya kaybı olmadığından emin olunması gerekmektedir.  
Alternatif Çözüm| Elasticsearch master node'unda **config/elasticsearch.yml** dosyası kontrol edilir. Burada diğer node'ların ip'leri bulunabilir ve onların da çalıştığından emin olunulmalıdır. Bağlı node'lar kapalıyken "**GET /_nodes** " isteği ile de bu node'ları göremezsiniz.
[code]
      
    
[/code]

Aşağıdaki komutlar ile node'ların, cluster'ın ve shard'ların durumu kontrol edilir.
[code]
      
    
[/code]

curl "&#60;ELASTICSEARCH_IP&#62;:9200/_nodes"
[code]
      
    
[/code]

curl "&#60;ELASTICSEARCH_IP&#62;:9200/_cluster/allocation/explain"
[code]
      
    
[/code]

curl "&#60;ELASTICSEARCH_IP&#62;:9200/_cat/shards?v=true&h=index,shard,prirep,state,node,unassigned.reason&s=state"  

[code]
      
    
[/code]

#Aşağıdaki komut ile node'lar üzerindeki paylaştırma tekrar aktif edilircurl -XPUT "&#60;ELASTICSEARCH_IP&#62;:9200/_cluster/settings?pretty" -H 'Content-Type: application/json' -d' { "transient" : { "cluster.routing.allocation.enable": true } }'
[code]
      
    
[/code]

#Üstteki komut yeterli olmadığında aşağıdaki komut ile bu işlem zorlanırcurl -XPOST "&#60;ELASTICSEARCH_IP&#62;:9200/_cluster/reroute?retry_failed=true&pretty"
[code]
      
    
[/code]  
  
Problem| 

### Nas ile bağlanan diskin mount edilmesinde yaşanan erişim hatası  
  
---|---  
Sebep/Neden| NAS diskine bağlanmaya çalışırken, dosya sistemi erişim izinlerinin ayarlanması gerekmektedir.   
Çözüm| nas disk: //192.168.111.248/LogApinizer  
#“id elasticsearch” ile ilgili kullanıcının id bilgileri alınıruid=1000(elasticsearch) gid=1000(elasticsearch) groups=1000(elasticsearch),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),101(lxd)  
#NAS diskini mount etmek için uygun yetkiler verilerek aşağıdaki komutla mount işlemi yapılır.sudo mount -t cifs -o rw,uid=1000,gid=1000,file_mode=0755,dir_mode=0755,username=elasticsearch,password=1234 //192.168.111.248/LogApinizer /home/data/  
#Mount işleminin kalıcı olması için fstab dosyasına aşağıdaki satırları ekleriz.vi /etc/fstab//192.168.111.248/LogApinizer /home/data cifs rw,uid=1000,gid=1000,file_mode=0755,dir_mode=0755,username=elasticsearch,password=1234 0 0  
  
×