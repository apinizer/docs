---
title: "CentOS 7 üzerine Private Docker Registry"
description: "Docker kayıt defterinin CentOS 7 işletim sistemine sahip sunucuya yüklenmesi ve yapılandırılması için gerekli adımları sağlar. Private Docker Registry kurulumu ile Docker image'larını yerel olarak saklayabilir ve yönetebilirsiniz."
---

<Info>
  CentOS 7.4'teki docker dağıtım paketi, ekstra havuzda mevcuttur. CentOS 7 sisteminizde devre dışı bırakılmışsa etkinleştirmeniz gerekebilir.
</Info>

## Kurulum Adımları

<Steps>
  <Step title="Docker Distribution kurulumu">
    Docker Distribution paketini kurun:
    
    ```bash
    sudo yum -y install docker-distribution
    ```
  </Step>
  
  <Step title="Docker Kayıt Defterini yapılandırma">
    Docker kayıt defteri yapılandırma dosyası **/etc/docker-distribution/registry/config.yml** adresinde bulunur. YAML biçimindedir. Herhangi bir değişiklik yapmanız gerekirse, burada yapın.

    Örnek yapılandırma dosyası:
    
    ```yaml
    version: 0.1
    log:
      fields:
        service: registry
    storage:
      cache:
        layerinfo: inmemory
      filesystem:
        rootdirectory: /var/lib/registry
    http:
      addr: :5000
    ```
    
    <Info>
      Varsayılan yapılandırma dosyasından:
      
      * **/var/lib/registry**: Docker image'larının depolanacağı dizindir
      * **Service**: Tüm ağ arayüzlerinde 5000 numaralı bağlantı noktasına bağlanır
    </Info>
  </Step>
  
  <Step title="SELinux ve Güvenlik Duvarı yapılandırması">
    <Warning>
      SELinux'u etkinleştirdiyseniz, 5000 numaralı bağlantı noktasını kullanırken bir sorunla karşılaşabilirsiniz. SELinux'u devre dışı bırakmayı veya sorunlarla karşılaşırsanız izin verici moda getirmeyi düşünün.
    </Warning>
    
    Güvenlik duvarı etkinse ve çalışıyorsa, güvenlik duvarında bağlantı noktasına izin verin:
    
    ```bash
    firewall-cmd --add-port=5000/tcp
    firewall-cmd --reload
    ```
  </Step>
  
  <Step title="Docker Kayıt Defterini başlatma">
    Hizmeti başlatın ve önyüklemede başlayacak şekilde ayarlayın:
    
    ```bash
    systemctl start docker-distribution
    systemctl enable docker-distribution
    ```
    
    Docker dağıtım hizmetinin çalıştığını doğrulayın:
    
    ```bash
    systemctl status docker-distribution
    ```
  </Step>
</Steps>

Örnek çıktı:

```
● docker-distribution.service - v2 Registry server for Docker
   Loaded: loaded (/usr/lib/systemd/system/docker-distribution.service; disabled; vendor preset: disabled)
   Active: active (running) since Sat 2018-03-31 14:31:16 EDT; 2min 20s ago
 Main PID: 16262 (registry)
   CGroup: /system.slice/docker-distribution.service
           └─16262 /usr/bin/registry serve /etc/docker-distribution/registry/...
```

## Kayıt Defteri'ni Docker Engine'e Ekleme

<Info>
  Aşağıdaki bilgi Apinizer kurulumunda Kubernetes 1.18.x ve Docker uygulamaları birlikte kurulduğu zaman kullanılacaktır.
</Info>

Varsayılan olarak Docker, Docker kayıt defterine bağlanmak için HTTPS kullanır. Güvenilir bir ağ üzerindeyseniz, güvenli olmayan bir kayıt defterini kullanabilirsiniz. Bu, dahili kullanım için CA imzalı sertifika ihtiyacını veya tüm Docker düğümlerinde kendinden imzalı sertifikaya güvenmeyi ortadan kaldırır.

<Steps>
  <Step title="Docker daemon.json yapılandırması">
    **/etc/docker/daemon.json** dosyasını düzenleyin:
    
    ```bash
    vi /etc/docker/daemon.json
    ```
    
    Dosya içindeki tüm satırları silip aşağıdaki satırı ekleyin:
    
    ```json
    {
      "insecure-registries" : ["dockerregistry.local:5000"]
    }
    ```
    
    <Warning>
      Yukarıdaki satırı **/etc/docker/daemon.json** Docker registry'e bağlanacak tüm sunucular üzerinde yapılması gerekmektedir.
    </Warning>
    
    <Info>
      `"insecure-registries" : ["192.168.X.X:5000"]` bu şekilde de eklenebilir.
    </Info>
  </Step>
  
  <Step title="Hostname yapılandırması">
    Bir DNS sunucunuz yoksa, ana bilgisayar adını IP adresiyle eşlemek için /etc/hosts dosyasını kullanın:
    
    ```bash
    cat /etc/hosts
    192.168.X.X dockerregistry.local
    ```
    
    <Note>
      Hostname yazılıyorsa, Kubernetes cluster içindeki diğer makinelerinde host dosyalarında belirtilmesi gerekmektedir.
    </Note>
  </Step>
  
  <Step title="Docker'ı yeniden başlatma">
    Değişiklikleri uygulamak için Docker'ı yeniden başlatın:
    
    ```bash
    systemctl restart docker
    ```
  </Step>
</Steps>

## Docker Kayıt Defteri Kullanımı

Private Docker Registry'ye image'ları yüklemek ve yönetmek için aşağıdaki adımları izleyin.

<Steps>
  <Step title="Image'ı indirme">
    Docker registry kurulmuş olan ortama image'ları indirin:
    
    ```bash
    sudo docker pull apinizercloud/manager:<APINIZER_VERSION>
    ```
  </Step>
  
  <Step title="Image'ı etiketleme">
    Image'ı **dockerregistry.local:5000/manager:{`<APINIZER_VERSION>`}** olarak etiketleyin. Bu, mevcut image için ek bir etiket oluşturur:
    
    ```bash
    docker tag apinizercloud/manager:<APINIZER_VERSION> dockerregistry.local:5000/manager:<APINIZER_VERSION>
    ```
    
    <Info>
      Etiketin ilk kısmı bir ana bilgisayar adı ve bağlantı noktası olduğunda, Docker bunu push sırasında bir kayıt defterinin konumu olarak yorumlar.
    </Info>
  </Step>
  
  <Step title="Image'ı registry'ye gönderme">
    Image'ı yerel kayıt defterine gönderin:
    
    ```bash
    docker push dockerregistry.local:5000/manager:<APINIZER_VERSION>
    ```
    
    <Info>
      Image yükleme başarılı olduysa, sonunda sha256 hash almalısınız. Aktarılan image'lar **/var/lib/registry/docker/registry/v2/repositories** dizini altında saklanır.
    </Info>
  </Step>
  
  <Step title="Repository kontrolü">
    Aktarılan image'ları kontrol edin:
    
    ```bash
    ls /var/lib/registry/docker/registry/v2/repositories
    ```
  </Step>
</Steps>

### Örnek Kullanımlar

#### Manager, Worker ve Cache Image'larını Yükleme

Local registry'ye pull edilen image'ları push etmek için:

```bash
# Apinizer Image'ı yükleme
--- Manager ---
sudo docker pull apinizercloud/manager:<APINIZER_VERSION>
sudo docker tag apinizercloud/manager:<APINIZER_VERSION> <YOUR_IP>:5000/manager:<APINIZER_VERSION>
sudo docker push <YOUR_IP>:5000/manager:<APINIZER_VERSION>

--- Worker ---
sudo docker pull apinizercloud/worker:<APINIZER_VERSION>
sudo docker tag apinizercloud/worker:<APINIZER_VERSION> <YOUR_IP>:5000/worker:<APINIZER_VERSION>
sudo docker push <YOUR_IP>:5000/worker:<APINIZER_VERSION>

--- Cache ---
sudo docker pull apinizercloud/cache:<APINIZER_VERSION>
sudo docker tag apinizercloud/cache:<APINIZER_VERSION> <YOUR_IP>:5000/cache:<APINIZER_VERSION>
sudo docker push <YOUR_IP>:5000/cache:<APINIZER_VERSION>
```

#### .tar Dosyasından Image Yükleme

.tar olarak alınmış bir Apinizer image'ının registry'ye yüklenmesi:

```bash
# Apinizer Image'ı yükleme
docker image load < apinizer-manager.tar
docker tag apinizer-manager:latest <YOUR_IP>:5000/apinizer-manager:latest
docker push <YOUR_IP>:5000/apinizer-manager:latest
```

## Linux Shell Script ile Image'leri Local Docker Registry'e Ekleme

### Otomatik Image Yükleme Scripti

Apinizer image'larını otomatik olarak local Docker registry'ye yüklemek için aşağıdaki script'i kullanabilirsiniz:

```bash
vi pullApinizerImages.sh
```

Script içeriği:

```bash
#!/bin/bash

localRepositoryUrl=<YOUR_IP>:5000

if [ "$localRepositoryUrl" == "<YOUR_IP>:5000" ]; then
  echo "Please enter your local Docker Repository URL"
else
  echo "Your Local Repository Url : "$localRepositoryUrl
fi

if [ $# -eq 0 ]; then
  echo "Please enter the version information as a parameter."
  exit
fi

echo 'Version = ' $1
version=$1

docker pull apinizercloud/manager:"$version"
docker tag apinizercloud/manager:$version $localRepositoryUrl/manager:$version
docker push $localRepositoryUrl/manager:$version

docker pull apinizercloud/worker:$version
docker tag apinizercloud/worker:$version $localRepositoryUrl/worker:$version
docker push $localRepositoryUrl/worker:$version

docker pull apinizercloud/cache:$version
docker tag apinizercloud/cache:$version $localRepositoryUrl/cache:$version
docker push $localRepositoryUrl/cache:$version

echo "Image pull operation completed."
```

**Kullanımı:**

```bash
sh pullApinizerImages.sh <APINIZER_VERSION>
```

## Registry API Kullanımı

### Catalog Bilgisi Sorgulama

Registry'deki tüm repository'leri listelemek için:

```bash
curl http://<YOUR_IP>:5000/v2/_catalog
```

Örnek çıktı:

```json
{
  "repositories": [
    "cache",
    "manager",
    "worker"
  ]
}
```

### Image Tag'lerini Listeleme

Belirli bir image'ın tag'lerini listelemek için:

```bash
curl http://<YOUR_IP>:5000/v2/manager/tags/list
```

Örnek çıktı:

```json
{
  "name": "manager",
  "tags": [
    "<APINIZER_VERSION>"
  ]
}
```

## Kubernetes Deployment Yapılandırması

Kubernetes'te Apinizer deploy dosyalarında private registry kullanmak için:

```yaml
image: myregistry.local:5000/apinizercloud/manager:<APINIZER_VERSION>
```

## Repository Temizleme

Repository'deki image'ları silmek için:

```bash
cd /var/lib/registry/docker/registry/v2/repositories
sudo rm -rf *
```

<Note>
  Local Docker Registry kurarken dikkat edilmesi gereken bir diğer konu SSL'dir.
  
  Daha fazla bilgi için: [https://github.com/Juniper/contrail-docker/wiki/Configure-docker-service-to-use-insecure-registry](https://github.com/Juniper/contrail-docker/wiki/Configure-docker-service-to-use-insecure-registry)
</Note>

### Kullanılmayan Image'ları Temizleme

Kullanılmayan image'ları temizlemek için:

```bash
docker image prune -a
```

