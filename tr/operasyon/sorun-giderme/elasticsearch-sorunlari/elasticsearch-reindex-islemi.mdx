---
title: "Elasticsearch Reindex İşlemi"
description: 'Elasticsearch Reindex İşlemi'
---

*   *   *   *   * 

  * [Apinizer Dokümantasyonu](/apinizer-dokumantasyonu/apinizer-dokuemantasyonuna-hos-geldiniz-1179695.html)
  * [Sorun Giderme](/apinizer-dokumantasyonu/sorun-giderme-6685033.html)
  * [Elasticsearch Olası Sorunları ve Çözümleri](/apinizer-dokumantasyonu/elasticsearch-olasi-sorunlari-ve-coezuemleri-75810288.html)
  * Current: Elasticsearch Reindex İşlemi

# Elasticsearch Reindex İşlemi

Elasticsearch'te tutulan verilerin mapping type değerinin değişmesi gerektiğinde (Bkz: Apinizer 2022.12.01) doğru arama sonuçlarının gelmesi için eski indexlerin reindeks yapılarak mapping type'larının güncellenmesi gerekir.

Yeni indexler yeni mapping type kullanacağından bir sorun olmaz.

Bu dökümanda mapping type değişmesi durumunda reindex işleminin nasıl gerçekleştirileceği anlatılmaktadır.

Apinizer'ın güncel index ve mapping type'larına [bu sayfadan](/apinizer-dokumantasyonu/elasticsearch-manuel-ilm-politikasi-ve-template-olusturma-70848927.html) erişebilirsiniz.

  

**Yapılacaklar**

1) Mapping'de Field Type Görüntülemek için:
```bash
    curl --location --request GET 'http://&#60;ELASTICSEARCH_IP&#62;:9200/apinizer-log-apiproxy-&#60;XXXX&#62;/_field_caps?fields=hr1ra'
```

POWERSHELL

  

2) Yeni template oluşturulması:

Not: Apinizer'da bu işlem 2022.12.01 versiyonunda kod ile yapıldı, bu düzenlemeyi manuel yapmak için lütfen şu adresi inceleyiniz:

[https://www.elastic.co/guide/en/elasticsearch/reference/7.9/indices-templates-v1.html](https://www.elastic.co/guide/en/elasticsearch/reference/7.9/indices-templates-v1.html)

  

3) Yeni template'in geçerli olabilmesi için ILM'nin kriterinin ekrandan değiştirilmesi ve yeni indekse geçmesi için arkaplanda servis trafiğinin akmaya devam etmesi gerekmektedir. Bunun da hemen yansıması için aşağıdaki kod ile poll_interval'in düşürülmesi işleri hızlandıracaktır:
```bash
     curl --location --request PUT 'http://&#60;ELASTICSEARCH_IP&#62;:9200/_cluster/settings' \
    --header 'Content-Type: application/json' \
    --data-raw '{"persistent":{"indices.lifecycle.poll_interval":"10s"}}'
```

POWERSHELL

  

4) Değişiklik yansıyıp yeni index oluştuktan sonra ILM'nin ve poll_interval'in eski haline alınması gerekmektedir:
```bash
    curl --location --request PUT 'http://&#60;ELASTICSEARCH_IP&#62;:9200/_cluster/settings' \
    --header 'Content-Type: application/json' \
    --data-raw '{"persistent":{"indices.lifecycle.poll_interval":null}}'
```

POWERSHELL

  

5) Reindeks işlemi ile datastreamdeki eski mapping type'da kalan indexin "reindexed" olarak başka bir indexe taşınması:  
(Reindekste yeni mapping kullanılacak.Yeni mapping template'den alınacağı için template'in geçerli olabilmesi için yeni indexin adının "apinizer-log-apiproxy-&#60;env adi:test&#62;-" içermesi gerekli )
```bash
    curl --location --request POST 'http://&#60;ELASTICSEARCH_IP&#62;:9200/_reindex' \
    --header 'Content-Type: application/json' \
    --data-raw '{
        "conflicts": "proceed",
        "source": {
            "index": ".ds-apinizer-log-apiproxy-test-000001"
        },
        "dest": {
            "index": ".ds-apinizer-log-apiproxy-test-000001-reindexed",
            "op_type": "create"
        }
    }'
```

POWERSHELL

  

6) Eski mapping type'da kalan indexin silinmesi:
```bash
    curl --location --request DELETE 'http://&#60;ELASTICSEARCH_IP&#62;:9200/.ds-apinizer-log-apiproxy-test-000001'
```

POWERSHELL

  

![](/apinizer-dokumantasyonu/_/05BD9F48017A5D1E2319A7812864C3E5/1699865923290/images/common/warning-macro-icon.svg)

Eğer yeni indeksi mevcut sistemden farklı bir isim ile oluşturursanız aşağıdaki adımlarla devam etmeniz gerekmektedir.

Aşağıdaki adımlarda, yukarıdaki isimlemenin ".ds" ifadesini kapsamadığı varsayılarak devam edilmiştir.

  

7)"apinizer-log-apiproxy-test-000001-reindexed" isimli indexe taşınan verilerin manager üzerinde görüntülenebilmesi için isminin değiştirilmesi gerekmektedir.

# Yeni index'i read-only moda almak:
```bash
     curl --location --request PUT 'http://&#60;ELASTICSEARCH_IP&#62;:9200/apinizer-log-apiproxy-test-000001-reindexed/_settings' \
    --header 'Content-Type: application/json' \
    --data-raw '{
      "settings": {
        "index.blocks.write": "true"
      }
    }'
    
    
```

POWERSHELL

  

# Yeni indexi orijinal isme klonlamak ve read-only moddan çıkarmak:
```bash
     curl --location --request PUT 'http://&#60;ELASTICSEARCH_IP&#62;:9200/apinizer-log-apiproxy-test-000001-reindexed/_clone/.ds-apinizer-log-apiproxy-test-000001' \
    --header 'Content-Type: application/json' \
    --data-raw '{
      "settings": {
        "index.blocks.write": null 
      }
    }'
```

POWERSHELL

  

# Hedef indeksin durumu green olana kadar beklenir:
```bash
     GET /_cluster/health/target_index?wait_for_status=green&timeout=30s
```

POWERSHELL

  

# Normalde hızlıca gerçekleşen bu işlem uzun süre alıyorsa aşağıdaki komutlar ile sorun var mı diye kontrol yapılır:
```bash
    GET /_cat/indices/target_index
    GET /_cat/recovery/target_index
    GET /_cluster/allocation/explain
```

POWERSHELL

  

# Eski indeks silinir:
```bash
    curl --location --request DELETE 'http://&#60;ELASTICSEARCH_IP&#62;:9200/apinizer-log-apiproxy-test-000001-reindexed'
```

POWERSHELL

  

# Reindeks yapsaydık templateden dolayı ilm otomatik yakalanır ve eklenirdi, fakat clone yaptığımızda sadece adı değişti diğer tüm ayarlar olduğu gibi yenisine geçti.  
# ilm kontrol ettiğimizde boş olduğunu göreceğiz:
```bash
    curl -X GET "http://&#60;ELASTICSEARCH_IP&#62;:9200/.ds-apinizer-log-apiproxy-test-000001/_ilm/explain?pretty"
```

POWERSHELL

  

# Bu yüzden yeni indekse ilm'nin eklenmesi gerekli:
```bash
curl -X PUT "http://&#60;ELASTICSEARCH_IP&#62;:9200/.ds-apinizer-log-apiproxy-test-000001/_settings?pretty" -H 'Content-Type: application/json' -d'
{
  "index": {
    "lifecycle": {
      "name": "apinizer-log-ilm-policy-test"
    }
  }
}
'
```
```

POWERSHELL

![](/apinizer-dokumantasyonu/_/05BD9F48017A5D1E2319A7812864C3E5/1699865923290/images/common/info-macro-icon.svg)

Reindeks işlemi için detaylı bilgi: [https://www.elastic.co/guide/en/elasticsearch/reference/7.9/docs-reindex.html](https://www.elastic.co/guide/en/elasticsearch/reference/7.9/docs-reindex.html)

×