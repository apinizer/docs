---
title: 'Message Flow & Policy Pipeline'
description: 'Mesaj akışı ve politika pipeline'ı, API Proxy'de isteklerin nasıl işlendiğini gösterir'
---

Message Flow (Mesaj Akışı) ve Policy Pipeline (Politika Boru Hattı), API Proxy'de isteklerin ve yanıtların nasıl işlendiğini gösteren kavramlardır. Bu akış, mesajların hangi sırayla hangi politikalar tarafından işlendiğini tanımlar.

## Message Flow Genel Bakış

API Proxy'de bir istek geldiğinde, mesaj çeşitli aşamalardan geçer ve her aşamada belirli politikalar uygulanır:

```
İstemci İsteği
   │
   ▼
┌─────────────────────────────────┐
│ REQUEST PIPELINE                │
│                                 │
│ 1. Pre-flow Policies           │ ← İstek öncesi işlemler
│    ├─ Authentication            │
│    ├─ Authorization             │
│    └─ Rate Limiting            │
│                                 │
│ 2. Conditional Policies        │ ← Koşullu politikalar
│    └─ IF-THEN-ELSE             │
│                                 │
│ 3. Route Step                   │ ← Yönlendirme
│    └─ Upstream Target          │
│                                 │
│ 4. Post-flow Policies          │ ← İstek sonrası işlemler
│    └─ Request Transformation   │
└──────────────┬──────────────────┘
               │
               ▼
         Backend API
               │
               ▼
┌─────────────────────────────────┐
│ RESPONSE PIPELINE               │
│                                 │
│ 1. Post-flow Policies          │ ← Yanıt sonrası işlemler
│    ├─ Response Transformation  │
│    ├─ Masking                  │
│    └─ Logging                 │
└──────────────┬──────────────────┘
               │
               ▼
         İstemci Yanıtı
```

## Policy Pipeline Aşamaları

### 1. Pre-flow Policies (İstek Öncesi Politikalar)

İstek backend'e gönderilmeden önce çalışan politikalar:

<CardGroup cols={2}>
  <Card title="Güvenlik" icon="shield">
    * OAuth2 / OIDC / JWT Authentication
    * Basic / Digest Authentication
    * mTLS
    * IP Whitelist/Blacklist
  </Card>
  <Card title="Trafik Yönetimi" icon="gauge">
    * Rate Limiting
    * Quota Management
    * Time Restriction
  </Card>
  <Card title="Doğrulama" icon="check-circle">
    * JSON Schema Validation
    * XML Schema Validation
    * Min/Max Message Size
  </Card>
  <Card title="Zenginleştirme" icon="wand-magic-sparkles">
    * Header Addition
    * Script Execution
    * Message Enrichment
  </Card>
</CardGroup>

### 2. Conditional Policies (Koşullu Politikalar)

Koşullara bağlı olarak çalışan politikalar:

```
IF (condition) THEN
  └─ Policy A
ELSE IF (condition) THEN
  └─ Policy B
ELSE
  └─ Policy C
```

**Koşul Örnekleri:**
* Mesaj içeriğine göre (JSONPath, XPath)
* Header değerlerine göre
* Query parametrelerine göre
* IP adresine göre
* Zaman bazlı koşullar

### 3. Route Step (Yönlendirme Adımı)

İsteğin backend'e yönlendirildiği adım:

* **Upstream Target Seçimi**: Hangi backend'e gidecek?
* **Load Balancing**: Yük dengeleme stratejisi
* **Failover**: Hata durumunda alternatif backend

### 4. Post-flow Policies (İstek Sonrası Politikalar)

Backend'e istek gönderilmeden önce ve backend'den yanıt geldikten sonra çalışan politikalar:

<CardGroup cols={2}>
  <Card title="Request Post-flow" icon="arrow-right">
    * Request Transformation
    * Header Modification
    * Request Enrichment
  </Card>
  <Card title="Response Post-flow" icon="arrow-left">
    * Response Transformation
    * Data Masking
    * Response Enrichment
    * Logging
  </Card>
</CardGroup>

## Request, Response ve Error Pipelines

### Request Pipeline

İstek akışı şu sırayla işlenir:

1. **Pre-flow Policies**: Güvenlik ve doğrulama
2. **Conditional Policies**: Koşullu işlemler
3. **Route Step**: Backend'e yönlendirme
4. **Post-flow Policies (Request)**: İstek dönüştürme

### Response Pipeline

Yanıt akışı şu sırayla işlenir:

1. **Post-flow Policies (Response)**: Yanıt dönüştürme
2. **Masking**: Hassas veri maskeleme
3. **Logging**: İşlem kaydı
4. **Client Response**: İstemciye yanıt

### Error Pipeline

Hata durumunda şu akış izlenir:

1. **Fault Handler Policies**: Hata yakalama politikaları
2. **Error Transformation**: Hata mesajı dönüştürme
3. **Error Logging**: Hata kaydı
4. **Error Response**: İstemciye hata yanıtı

## Policy Execution Order

Politikalar tanımlandıkları sırayla çalıştırılır. Bu sıra kritik öneme sahiptir:

<Warning>
  **Önemli**: Politika sırası önemlidir. Örneğin, kimlik doğrulama politikası rate limiting politikasından önce çalışmalıdır. Aksi halde kimlik doğrulaması yapılmamış istekler rate limiting'e takılabilir.
</Warning>

### Önerilen Sıralama

1. **Güvenlik Politikaları** (Authentication, Authorization)
2. **Trafik Yönetimi** (Rate Limiting, Quota)
3. **Doğrulama** (Schema Validation)
4. **Dönüştürme** (Transform)
5. **Zenginleştirme** (Enrichment)

## Condition-based Policy Execution

Politikalar koşullara bağlı olarak çalıştırılabilir:

### Koşul Türleri

<AccordionGroup>
  <Accordion title="Mesaj İçeriği Koşulları">
    * JSONPath expression
    * XPath expression
    * Header değerleri
    * Query parametreleri
  </Accordion>
  
  <Accordion title="İstemci Koşulları">
    * IP adresi
    * User agent
    * API Key
    * Credential
  </Accordion>
  
  <Accordion title="Zaman Koşulları">
    * Tarih aralığı
    * Saat aralığı
    * Gün bazlı
  </Accordion>
  
  <Accordion title="Sistem Koşulları">
    * Environment variable
    * System property
    * Cache değeri
  </Accordion>
</AccordionGroup>

### Koşul Örneği

```
IF request.header["Content-Type"] == "application/json" THEN
  └─ JSON Schema Validation Policy
ELSE IF request.header["Content-Type"] == "application/xml" THEN
  └─ XML Schema Validation Policy
ELSE
  └─ Reject Request
```

## API Proxy'de Mesaja Politikalar Uygulanması

Bir mesaj API Proxy'ye geldiğinde:

1. **Mesaj Alınır**: İstemciden gelen istek alınır
2. **Pre-flow Çalıştırılır**: Güvenlik ve doğrulama politikaları uygulanır
3. **Koşullar Kontrol Edilir**: Conditional policies için koşullar değerlendirilir
4. **Yönlendirme Yapılır**: Backend'e yönlendirme yapılır
5. **Post-flow Çalıştırılır**: Yanıt dönüştürme ve loglama yapılır
6. **Yanıt Gönderilir**: İstemciye yanıt gönderilir

## Sonraki Adımlar

<CardGroup cols={2}>
  <Card title="Policy Nedir?" icon="shield" href="/tr/apinizer-anlama/temel-kavramlar/policy-nedir">
    Politika kavramını öğrenin
  </Card>
  <Card title="Routing" icon="route" href="/tr/apinizer-anlama/temel-kavramlar/routing">
    Routing kavramını öğrenin
  </Card>
  <Card title="Politika Yönetimi" icon="gear" href="/tr/gelistirici/politika-yonetimi/development-tab">
    Politika yönetimi ve yapılandırması
  </Card>
  <Card title="Conditional Policies" icon="code-branch" href="/tr/gelistirici/politika-yonetimi/development-tab/conditional-policies">
    Koşullu politika çalıştırma
  </Card>
</CardGroup>