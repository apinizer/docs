
# Ağ Geçidi Ortamları (Gateways Environments)

Ortam (Environment), bir kuruluttaki API Proxy'leri (API Proxy) için bir çalışma zamanı yürütme bağlamıdır (Runtime Execution Context).

Bu bölümde, ortam oluşturma ve ilgili işlemler anlatılmaktadır.

<Info>
Sistem Genel Ayarlar ekranı üzerinden, **Kubernetes Namespace ve Resource'lar Apinizer ile yönetilsin** seçeneği Aktif olarak işaretlendiğinde gelmektedir.
</Info>

## Ortam Oluşturma

Ortam oluştururken genel tanım bilgilerini içeren görsellere aşağıda yer verilmiştir:

<img
  src="/images/yonetici/ortam-olusturma.png"
  alt="Image 2024 9 9 15 35 35 Pn"
  width="1000"
  className="mr-auto"
/>


Ortam oluştururken genel tanım bilgilerini içeren alanlar:

| Alan | Açıklama |
|------|----------|
| **Tür** (Type) | Lisans'a ve kullanılan ortama uygun bir değer seçilmesi gerekmektedir. Test veya Üretim (Production) seçilebilir. |
| **İletişim Protokolü Türü** (Communication Protocol Type) | HTTP, gRPC, HTTP+Websocket iletişim protokollerinden birisi seçilebilir. |
| **Ad** (Name) | Ortamın adı. Kubernetes'teki namespace'e karşılık gelmektedir. |
| **Anahtar** (Key) | Oluşturulan ortam için kullanılan ve ortama özgü kısaltılmış bir anahtardır. |
| **Node Listesi** (Node List) | Oluşturulan ortamın hangi kubernetes sunucularında çalışacağı seçilir. |
| **Proje** (Project) | Ortamın kullanılabileceği projeleri buradan seçebilir ya da tüm projelerde kullanılabilmesi için seçimi boş bırakılabilir. |
| **Erişim URL Adresi** (Access URL) | Ortam içinde çalışan API Proxy'lerin dış erişim adresidir. |
| **Açıklama** (Description) | Yönetim kolaylığı ve önemli notlar için kullanılabilir. |
| **Gateway Sunucusu Erişim URL'si** | Apinizer Yönetim konsolunda yapılan konfigürasyonların Gateway Pod'larına yüklenebilmesi için gerekli olan nodeport veya ingress tipindeki servis erişim adresi. |
| **Cache Sunucusu Erişim URL'si** | Apinizer Yönetim konsolunda yapılan konfigürasyonların Cache Pod'larına yüklenebilmesi için gerekli olan servis erişim adresi. |

<Warning>
**İletişim Protokolü Türü Seçimi:**

API Proxylerin hangi ortama deploy edilebileceğini burada seçilen tür belirler:
- REST ve SOAP API Proxyler → **HTTP** tipindeki ortama
- gRPC API Proxyleri → **gRPC** tipindeki ortama
- Websocket API Proxyler → **HTTP+Websocket** tipindeki ortama deploy edilebilir
</Warning>

<Tip>
**Proje Seçimi:** Proje seçilmesi durumunda sadece o proje içerisinde yer alan API Proxy'lerin bu ortama deploy edilebileceği anlamına gelir.
</Tip>

### API Proxy Trafik Log Konnektörleri

Ortamdaki tüm API Proxy Trafiğinin ve uzantılarının loglanacağı log konnektörleri buradan tanımlanır.

API Proxy Trafik Log Konnektörü tanımlamalarını içeren görsele aşağıda yer verilmiştir:
<img
  src="/images/yonetici/log-konnektor.png"
  alt="Image 2024 9 9 15 35 35 Pn"
  width="1000"
  className="mr-auto"
/>

Ortama konnektör ekleme hakkında daha fazla bilgi için [bu sayfaya](/connectors) bakın.

## Gateway Engine ve Cache Sunucu Ayarları

Gateway engine ve Cache sunucusu, Kubernetes ortamındaki pod'lara karşılık gelmektedir.

- **Gateway engine** (`apinizer-worker`): Apinizer Platform'un çekirdek (core) modülüdür, tüm API isteklerinin BackendAPI'ye yönlendirilmesinden sorumludur ve Policy Enforcement Point olarak çalışır
- **Cache sunucusu** (`apinizer-cache`): Apinizer'da gerek duyulan Cache değerlerinin tutulduğu ortamdır

Gateway engine ve Cache sunucu tanımlamalarını içeren görsellere aşağıda yer verilmiştir:
<img
  src="/images/yonetici/getway-engine.png"
  alt="Image 2024 9 9 15 35 35 Pn"
  width="1000"
  className="mr-auto"
/>

### Gateway Engine Konfigürasyonu

<AccordionGroup>
  <Accordion title="Temel Ayarlar" icon="sliders">
    | Alan | Açıklama |
    |------|----------|
    | **Sayı** (Count) | Gateway engine sayısı, Kubernetes deployment'taki "replicas" değerine karşılık gelmektedir. |
    | **CPU** | Pod'un kullanacağı maksimum CPU core sayısı bilgisidir. |
    | **Bellek** (Memory) | Pod'un kullanacağı maksimum bellek değeridir. |
    | **Bellek Birimi** (Memory Unit) | Bellek için gerekli olan değerin birimi seçilir; MB, GB. |

    **Önerilen Değerler:**

    | CPU | Bellek Boyutu |
    |-----|---------------|
    | 1   | 2GB           |
    | 2   | 4GB           |
    | 4   | 6GB           |
    | 8   | 10GB          |
  </Accordion>

  <Accordion title="Servis Erişim Bilgileri" icon="network-wired">
    - **HTTP Etkin** (HTTP Enabled): Varsayılan olarak seçili olarak gelir
    - **HTTPS Etkin** (HTTPS Enabled): HTTPS kullanılmak istenirse bu seçenek de seçilir, bu durumda şifreleme için gerekli dosyalar yüklenmelidir
    - **mTLS**: HTTPS protokolü üzerinde çalıştığından sadece HTTPS ayarı açıkken seçilebilir

    **Keystore ve Truststore:** HTTPS protokülü seçildiğinde, keystore ve truststore dosyaları JKS veya PFX formatında yüklenebilir.

    **Servis Portları:** 30080-32767 aralığında bir servisin portu girilir. Servis Kubernetes'te NodePort olarak oluşacaktır.
  </Accordion>

  <Accordion title="Ek Değişkenler (Additional Variables)" icon="code">
    Pod içinde çalıştırılacak varsayılan ve opsiyonel değişkenler ve değerleri tanımlanır.

    **Önemli Değişkenler:**

    | Değişken | Hedef Ortam | Açıklama |
    |----------|-------------|----------|
    | `JAVA_OPTS` | Hepsi | JVM Heap değerlerini ayarlar |
    | `tuneWorkerThreads` | HTTP Worker, HTTP+Websocket, Management API | Sunucunun minimum Worker thread sayısı |
    | `tuneWorkerMaxThreads` | HTTP Worker, HTTP+Websocket, Management API | Sunucunun maksimum Worker thread sayısı |
    | `tuneBufferSize` | HTTP Worker, HTTP+Websocket, Management API | Thread'in yazma işlemi için kullanacağı buffer alanı |
    | `tuneIoThreads` | HTTP Worker, HTTP+Websocket, Management API | IO Thread sayısı |
    | `logLevel` | Hepsi | Uygulama loglarının seviyesi (ERROR, WARNING, INFO, DEBUG, TRACE, OFF) |

    <Tip>
    **CPU'ya Göre Önerilen Thread Değerleri:**

    | CPU | tuneWorkerThreads | tuneWorkerMaxThreads |
    |-----|-------------------|----------------------|
    | 1   | 512               | 1024                 |
    | 2   | 1024              | 2048                 |
    | 4   | 2048              | 4096                 |
    | 8   | 4096              | 8192                 |
    </Tip>
  </Accordion>

  <Accordion title="gRPC Protokolü Özel Ayarları" icon="g">
    Eğer Gateway Management API, gateway pod'lar ile HTTPS üzerinden iletişim kuracaksa:

    - **API Geçidi Yönetimi API erişimi için HTTPS hizmeti oluşturun** seçeneği seçilir
    - Keystore ve truststore dosyaları JKS veya PFX formatında yüklenebilir
    - Gateway Sunucusu Erişim URL'si girilir

    Örnek: `https://worker-http-service.prod.svc.cluster.local:8443`
  </Accordion>

  <Accordion title="Güvenlik Yapılandırması" icon="shield">
    Ek Değişkenler ile güvenlik yapılandırması yapılabilir:

    | Değişken | Açıklama | Varsayılan Değer |
    |----------|----------|------------------|
    | `jdkTLSVersions` | Desteklenecek TLS protokol versiyonları | TLSv1, TLSv1.1, TLSv1.2, TLSv1.3 |
    | `jdkTLSDisabledAlgorithms` | Güvenlik nedeniyle devre dışı bırakılacak TLS algoritmaları | RC4, DES, MD5withRSA, DH keySize < 768... |
    | `jdkCipherSuites` | Kullanılacak şifreleme takımları | JDK varsayılan değeri |

    <Warning>
    **Güvenlik Önerileri:**
    - TLSv1.2 ve üstü versiyonların kullanılması önerilir
    - GCM modlu şifreleme takımları tercih edilmelidir
    - Zayıf algoritmalar (RC4, DES, 3DES) devre dışı bırakılmalıdır
    - Anahtar boyutları yeterli güvenlik seviyesinde olmalıdır (RSA için en az 2048 bit, EC için en az 224 bit)
    </Warning>
  </Accordion>
</AccordionGroup>

### Cache Server Konfigürasyonu

<AccordionGroup>
  <Accordion title="Temel Ayarlar" icon="database">
    | Alan | Açıklama |
    |------|----------|
    | **Cache Sayı** | Cache sayısı, Kubernetes Cluster'daki replicaSet ile eş değerdir. |
    | **CPU** | Pod'un kullanacağı maksimum CPU core sayısı. |
    | **Bellek** | Pod'un kullanacağı maksimum bellek değeri. |

    **Önerilen Değerler:**

    | CPU | Bellek Boyutu |
    |-----|---------------|
    | 1   | 2GB + Tahmini Cache Büyüklüğü |
    | 2   | 4GB + Tahmini Cache Büyüklüğü |
    | 4   | 6GB + Tahmini Cache Büyüklüğü |
    | 8   | 10GB + Tahmini Cache Büyüklüğü |

    <Info>
    `-Xss256k` veya `-Xss128k` gibi değerler kullanarak thread başına bellek ihtiyacını azaltabilirsiniz.
    </Info>
  </Accordion>

  <Accordion title="Cache Server Ek Değişkenler" icon="gear">
    **Tomcat Ayarları:**

    | Değişken | Açıklama | CPU'ya Göre Önerilen Değerler |
    |----------|----------|-------------------------------|
    | `SERVER_TOMCAT_MAX_THREADS` | Tomcat'in işleyebileceği maksimum eşzamanlı istek sayısı | 1 CPU: 256, 2 CPU: 1024, 4 CPU: 2048, 8 CPU: 4096 |
    | `SERVER_TOMCAT_MIN_SPARE_THREADS` | Tomcat'in her zaman hazır tutacağı minimum thread sayısı | 1 CPU: 128, 2 CPU: 256, 4 CPU: 512, 8 CPU: 1024 |
    | `SERVER_TOMCAT_MAX_CONNECTIONS` | Tomcat'in aynı anda kabul edebileceği maksimum bağlantı sayısı | 1 CPU: 2048, 2 CPU: 4096, 4 CPU: 8192, 8 CPU: 16384 |

    **Hazelcast Ayarları:**

    | Değişken | Açıklama | Varsayılan |
    |----------|----------|------------|
    | `HAZELCAST_CLIENT_SMART` | Hazelcast client'ın akıllı yönlendirme kullanıp kullanmayacağı | true |
    | `HAZELCAST_MAPCONFIG_BACKUPCOUNT` | Hazelcast map verisinin kaç yedek kopyasının saklanacağı | 1 |
    | `HAZELCAST_PARTITION_COUNT` | Hazelcast partition sayısı | 271 |
    | `CACHE_SERVICE_NAME` | Cache'in kubernetes üzerinden diğer cache pod'larına erişebilmesi için gerekli servis adı | cache-hzservice |

    <Warning>
    **HAZELCAST_OPERATION_RESPONSEQUEUE_IDLESTRATEGY**

    Eğer bu parametreyi "backoff" ayarlarsanız: Pod'un CPU limitinin %90-100'ünü sürekli kullanacaktır. Bu durum %5-10 performans artışı sağlayabilir ancak Cache pod'unun CPU kaynaklarının limitini tüketir.
    </Warning>
  </Accordion>
</AccordionGroup>

## Host Takma Adlarını Ayarlama

### Host Takma Ad (Host Alias) Nedir?

Ağda bulunan IP adresleri bazen host isimleri arkasına konulabilir. Bunlar eğer nameserver ya da host dosyasına tanımlanmamışsa ya da bir şekilde Apinizer'ın bunları çözmesi sağlanamamışsa, worker pod'ların bu isimleri çözmesi için Host Alias tanımı yapılmalıdır.

Kubernetes üzerinde host adları ya da bunlara karşılık gelen IP adreslerine, takma host isimleri verilebilir. Bu ayar, deployment.yaml dosyası içinde tanımlanır.

**Örnek Kullanım:**

| IP Address | Host Aliases |
|------------|--------------|
| 10.10.10.10 | alias_name, other_alias_name |

Host takma adı ayarlarını içeren görsele aşağıda yer verilmiştir:
<img
  src="/images/yonetici/host-takma-adi.png"
  alt="Image 2024 9 9 15 35 35 Pn"
  width="1000"
  className="mr-auto"
/>


## Ortam Yayımlama

<Steps>
  <Step title="Yayınlanmamış Ortamı Seç">
    Bir ortam yayımlamak için **Yayınlanmamış** (Unpublished) butonuna tıklanır.
    <img
      src="/images/yonetici/step-1.png"
      alt="Image 2024 9 9 15 35 35 Pn"
      width="400"
      className="mr-auto"
    />
  </Step>

  <Step title="İşlemi Onayla">
    Gelen pencereden işlemi onaylamak için **Yayınla** (Publish) butonuna tıklanır ve ortam kubernetes sunucusuna dağıtılır (deploy).
     <img
          src="/images/yonetici/step2.png"
          alt="Image 2024 9 9 15 35 35 Pn"
          width="400"
          className="mr-auto"
        />
  </Step>
</Steps>

## Ortam Yeniden Yayınlama

<Steps>
  <Step title="Yayınlanmış Ortamı Seç">
    Yayımlanmış durumda olan bir ortamın üzerine gelerek **Yayınlanmış** (Published) butonuna tıklanır.
     <img
              src="/images/yonetici/step3.png"
              alt="Image 2024 9 9 15 35 35 Pn"
              width="400"
              className="mr-auto"
            />
  </Step>

  <Step title="Yeniden Yayınla">
    Gelen pencereden işlemi onaylamak için **Yeniden Yayınla** (Republish) butonuna tıklanır.
     <img
              src="/images/yonetici/step4.png"
              alt="Image 2024 9 9 15 35 35 Pn"
              width="400"
              className="mr-auto"
            />
  </Step>
</Steps>

<Info>
Ortam Yeniden Yayınla işleminden sonra, Pod'lar da yeniden başlatılır (restart).
</Info>

<Warning>
Burada yapılan değişikliklerin etkinleşmesi için republish işlemi gerekmektedir. Versiyon güncellemesine nazaran bu işlemde bir kaç dakikalık kesinti olacağına dikkat edilmelidir.
</Warning>

## JWT Token Doğrulama Anahtarı

Ortam kaydedilmiş ise JWT Token Doğrulama Anahtarı üretilmiştir. Bu token, kimlik doğrulama politikaları için Apinizer Token Servisi üzerinden token üretmede yer alan private key'in değeridir.

Bu bilgilere erişmek için **JWT Token Doğrulama Anahtarı** (JWT Token Validation Keys) tabına gidilir.

**Kullanılabilir İşlemler:**

- **Redeploy:** Mevcut anahtarın değişiklik yapılmadan sunuculara tekrar yüklenmesi
- **Regenerate & Deploy:** Yeni anahtar üretilip sunuculara yüklenmesi
- **Upload & Deploy:** PEM Encoded Private Key dosyası yüklenerek yeni anahtar üretilmesi
 <img
              src="/images/yonetici/jwt-token.png"
              alt="Image 2024 9 9 15 35 35 Pn"
              width="800"
              className="mr-auto"
            />

## Ortam (Environment) Silme

Ortam seçerek, en altta bulunan **Ortam Sil** (Remove Environment) tabından **Ortam Sil** (Remove Environment) diyerek ortam ile ilgili bilgileri veritabanından silinmiş olur.

 <img
              src="/images/yonetici/environment-silme.png"
              alt="Image 2024 9 9 15 35 35 Pn"
              width="800"
              className="mr-auto"
            />
<Danger>
**Dikkat:** Silme işlemi tamamlandığında bu ortamda kayıtlı tüm API Proxy'lerin yüklemesi de silinir ve bu ortama daha önceden yüklenmiş olan API Proxy'lere bu ortam üzerinden artık erişilemez.
</Danger>

## Önbellek Monitörü

API Proxy ekranının Genel Bilgi sekmesinde Cache bölümündeki ayarlar ile istek, önbelleğe alınarak, Backend API'ye gitmeden yanıtlanabilir. Aynı zamanda kota ve darboğaz (quota ve throttle) politikaları da cache pod'u üzerinden yönetilmektedir.

Ortam bazlı olarak önbellek işlemlerini izlemek, detayları görmek ve silmek için ortamın **Önbellek** (Cache) linkinden bu sayfaya gidilir.
<img
              src="/images/yonetici/on-bellek.png"
              alt="Image 2024 9 9 15 35 35 Pn"
              width="600"
              className="mr-auto"
            />

Önbellek Monitörünü içeren görsele aşağıda yer verilmiştir:
<img
              src="/images/yonetici/on-bellek2.png"
              alt="Image 2024 9 9 15 35 35 Pn"
              width="800"
              className="mr-auto"
            />


## Metrik Monitörü

Kubernetes üzerindeki Worker ve Cache pod'larının durumunu izlemek için ortam listesinden ilgili ortamın **Podlar** (Pods) linkine tıklanır.
Podlar ekranını içeren görsele aşağıda yer verilmiştir:

<img
              src="/images/yonetici/metrik.png"
              alt="Image 2024 9 9 15 35 35 Pn"
              width="800"
              className="mr-auto"
            />

<Info>
Eğer tüm ortamların metriklerine erişmek isterseniz [tüm ortam metrikleri sayfasına](/metrics/all-environments) tıklayınız.
</Info>

