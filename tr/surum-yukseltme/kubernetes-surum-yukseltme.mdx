---
title: "Kubernetes"
description: "Bu dökümanda, mevcut Linux işletim sistemi üzerinde bulunan bir Kubernetes kümesi 1.18 sürümünde ve Docker ile çalışıyor. Bu kümenin sürümünü 1.18'den 1.30'a yükseltme sürecinde yapılması gerekenler adım adım anlatılmaktadır."
---

Bu dökümanda, mevcut Linux işletim sistemi üzerinde bulunan bir Kubernetes kümesi 1.18 sürümünde ve Docker ile çalışıyor. Bu kümenin sürümünü 1.18'den 1.30'a yükseltme sürecinde yapılması gerekenler adım adım anlatılmaktadır.

<Warning>
  Kubernetes sürümünü yükseltirken, mevcut ve hedef sürümler arasındaki her bir küçük sürümün (örneğin, 1.25'ten 1.26'ya, sonra 1.26'dan 1.27'ye vb.) ardışık olarak yükseltilmesi gerekmektedir.
</Warning>

**KUBERNETES:** v1.18 → Mevcut versiyon, v1.30 → Hedeflenen versiyon

## Gerekli Dosyalar

* v1.18 - v1.30 → Kubectl, kubeadm, kubelet dosyaları
* Kubernetes-cni → Kubernetes 1.18 den 1.19 geçerken bir kere kurmak yeterli olacaktır. 1.19 ve üstü versiyonlarda kurulmasına gerek yoktur.
* containerd 1.6 → Kubernetes 1.24 versiyonuna geçerken containerd kullanımına geçilmeli. Containerd 1.6+ üstü olmalı ve docker kaldırılmalıdır.

Kubernetes için [http://fss.apinizer.com/index.php/s/uWP0ewA2sf2rS02](http://fss.apinizer.com/index.php/s/uWP0ewA2sf2rS02) adresinden gerekli dosyaları indirebilirsiniz.

Containerd için [http://fss.apinizer.com/index.php/s/TSlg6gWm6Aq4LJy](http://fss.apinizer.com/index.php/s/TSlg6gWm6Aq4LJy) adresinden gerekli dosyayı indirebilirsiniz.

## 1) Versiyon Yükseltme

Bu adım, **"1.18-1.19", "1.20-1.23" ve "1.24-1.30"** versiyon yükseltme bölümlerinden oluşmaktadır. Her bir bölümde, versiyon yükseltme süreci ve olası hataların çözümleri ele alınmaktadır.

### 1.1) 1.18'ten 1.19'a yükseltme

<Warning>
  **Çok Önemli**

  1.18'den 1.19'a geçişte olası flannel sorunu çıkabilmekte. Aşağıdaki komut ile node durumunu kontrol ediniz.

  ```bash
  kubectl get nodes
  ```

  Node durumu **NotReady** ise aşağıdaki komut ile ilgili sunucudaki loglara bakınız.

  ```bash
  journalctl -xeu kubelet
  ```

  **Çözüm yolu:** Herhangi bir (master veya worker) sunucu üzerinden flannel dosyasını, yükseltme yaptığınız sunucuya scp komutu ile dosyayı taşımak.

  ```bash
  scp /opt/cni/bin/flannel <USERNAME>@<NODE_IP>:/opt/cni/bin
  ```

  Node durumunu kontrol ettiğinizde **"READY"** olduğunu görmelisiniz.
</Warning>

#### Control Plane (Master) Node için Yükseltme

Master(control-plane) olan sunuya geçiş yapınız ve aşağıdaki adımları uygulayınız.

Yükseltme işlemine başlamadan önce kubeadm, kubelet ve kubectl versiyonlarını aşağıdaki komutlar ile kontrol ediniz.

```bash
kubeadm version
kubelet --version
kubectl version --client
```

##### Kubeadm Versiyon yükseltme

Kubeadm, için paket sabitlemesini kaldıralım.

```bash
sudo apt-mark unhold kubeadm
```

[https://fss.apinizer.com](https://fss.apinizer.com) adresi üzerinden indirdiğiniz dosyayı çıkarttığınız klasöre gidiniz.

```bash
cd 1.19.3
```

İçerisinde bulunan .deb uzantılı kubeadm dosyasını indirelim.

```bash
sudo dpkg -i kubeadm_1.19.3-00_amd64.deb
sudo apt-mark hold kubeadm
```

<Warning>
  Aşağıdaki drain komutu, belirtilen bir Kubernetes node'unu bakım durumuna alır ve podları diğer node'lara aktarır. Master (control-plane) node'unuza alternatif bir master node'a sahip değilseniz bu komut sistem kesintisine sebep olacaktır. Tek node'a sahip cluster'lar için bu işlemi uygulamayabilirsiniz.
</Warning>

```bash
kubectl drain <MASTER_NODE_NAME> --ignore-daemonsets
```

Kurulumu gerçekleştirilen v1.19.3 sürümüne upgrade komutu ile Kubeadm'i yükseltiniz.

```bash
#Master (control-plane) için:
#versiyon kısmını her bir sürümde değiştiriniz
sudo kubeadm upgrade apply v1.19.3
```

İşlemin başarılı olduğu belirten mesajı ekranda çıktı olarak görmelisiniz. Node'u tekrar kullanılabilir hale getiriniz.

```bash
kubectl uncordon <MASTER_NODE_NAME>
```

##### Kubelet ve Kubectl Versiyon yükseltme

```bash
sudo apt-mark unhold kubelet kubectl
sudo dpkg -i kubelet_1.19.3-00_amd64.deb
sudo dpkg -i kubectl_1.19.3-00_amd64.deb
sudo apt-mark hold kubelet kubectl
```

**Kubelet hizmetini yeniden başlatın.**

```bash
systemctl daemon-reload
systemctl restart kubelet
```

Master (control-plane) olan node'un versiyonunu görüntülemek için aşağıdaki komutu çalıştırınız.

```bash
kubectl get nodes
```

Versiyon olarak upgrade işleminin başarılı olduğunu kontrol edin.

#### Worker Node için Yükseltme

Worker node'un versiyon yükseltmesi de benzer adımlarla gerçekleştirilir.

<Warning>
  Aşağıdaki drain komutu, belirtilen bir Kubernetes node'unu bakım durumuna alır ve podları diğer node'lara aktarır. Worker node'unuza alternatif bir node'a sahip değilseniz bu komut sistem kesintisine sebep olacaktır. Tek worker node'a sahip cluster'lar için bu işlemi uygulamayabilirsiniz.

  Komut **master(control-plane)** sunucusunda çalıştırılır ve **worker node** için bakım ve pod boşaltma işlemini başlatır.
</Warning>

```bash
kubectl drain <WORKER_NODE_NAME> --ignore-daemonsets
```

**Worker node'un** bulunduğu sunucuya geçiş yapılır ve kubeadm yükseltme işlemini aşağıdaki komutlar ile gerçekleştirilir.

[https://fss.apinizer.com](https://fss.apinizer.com) adresi üzerinden indirdiğiniz dosyayı çıkarttığınız klasöre gidiniz.

```bash
sudo apt-mark unhold kubeadm
sudo dpkg -i kubeadm_1.19.3-00_amd64.deb
sudo apt-mark hold kubeadm
```

Worker node için yükseltme işlemini gerçekleştiriniz.

```bash
sudo kubeadm upgrade node
```

**Kubelet ve Kubectl Versiyon yükseltme**

```bash
sudo apt-mark unhold kubelet kubectl
sudo dpkg -i kubelet_1.19.3-00_amd64.deb
sudo dpkg -i kubectl_1.19.3-00_amd64.deb
sudo apt-mark hold kubelet kubectl
```

```bash
systemctl daemon-reload
systemctl restart kubelet
```

Aşağıdaki komutu master(control-plane) olan node'da çalıştırarak node'u tekrar kullanıma açınız.

```bash
kubectl uncordon <WORKER_NODE_NAME>
```

Worker node'un versiyonunu görüntülemek için aşağıdaki komutu çalıştırınız.

```bash
kubectl get nodes
```

### 1.2) 1.20'den 1.23'e yükseltme

1.20-1.23 versiyonları tek tek güncellenir. Her bir versiyon için yukarıdaki adımlar tekrarlanır.

### 1.3) 1.24'ten 1.30'a yükseltme

<Warning>
  **Çok Önemli**

  Kubernetes 1.24 versiyonuna geçerken Docker yerine Containerd kullanımına geçilmeli. Containerd 1.6+ üstü olmalı ve docker kaldırılmalıdır.
</Warning>

1.24-1.30 versiyonları tek tek güncellenir. Her bir versiyon için yukarıdaki adımlar tekrarlanır. Ancak 1.24'e geçerken containerd kurulumu yapılmalıdır.

## Containerd Kurulumu (Kubernetes 1.24 için)

Kubernetes 1.24 versiyonuna geçerken Docker yerine Containerd kullanımına geçilmelidir.

Containerd kurulumu için [http://fss.apinizer.com/index.php/s/TSlg6gWm6Aq4LJy](http://fss.apinizer.com/index.php/s/TSlg6gWm6Aq4LJy) adresinden gerekli dosyayı indirebilirsiniz.

Containerd kurulumu ve Docker'dan geçiş işlemleri için ilgili dokümantasyon sayfalarına bakınız.
