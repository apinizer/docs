---
title: "Mesaj İşleme ve Politika Uygulama"
description: "Mesaj akışı, politika pipeline'ı ve Request, Response, Error pipeline'ları, API Proxy'de mesajların nasıl işlendiğini gösterir. Geliştirme sekmesi, mesaj akışı sırasında istek ve yanıt mesajlarına uygulanacak politikaların biçimlendirildiği sekmedir. Arayüz bu akışı gösterecek şekilde tasarlanmıştır. Böylece kullanıcı görsel olarak bir istek mesajının hangi politikalar hangi sırada uygulandıktan sonra Backend API'ye gönderileceğini ve Backend API'den dönen yanıt mesajı istemciye iletilmeden önce hangi sırada hangi politikaların uygulanacağını görme olanağı kazanır."
---

## Mesaj Akışı ve Pipeline Yapısı

### İstemci ve Backend API

İstemci ile Backend API arasındaki akış şu elementlerle gösterilmektedir:

- İstemciden çıkıp Backend API'ye giden istek mesajını sembolize eden bir ok
- Backend API'den çıkıp İstemciye giden yanıt mesajını sembolize eden bir ok
- İstek ya da yanıt mesajı üzerinde uygulanan politikaları ve uygulanma sırasını gösteren ikonlar

**İstemci**: Arayüzde sol taraftaki çerçeve içinde gösterilir. API Proxy'e istek gönderen paydaştır. Akışı başlatır. İstemciden çıkan mesaj, politikalar uygulandıktan sonra Backend API'ye ulaşır.

**Backend API**: API Proxy ile istemcinin doğrudan erişimine kapatılan ve istemciden saklanan, istekleri API Proxy'den alıp yanıtlarını API Proxy'e döndüren orijinal API'dir. Arayüzünde sağ taraftaki çerçeve ile gösterilir. Backend API'nin yanıtı, politikalar uygulandıktan sonra İstemciye gönderilir.

<img src="/images/develop/message-processing/istemci.png" alt="İstemci" width="800" height="auto" />

<img src="/images/develop/message-processing/backend-api.png" alt="Backend API" width="800" height="auto" />

Backend API kutusundaki **API** bağlantısına tıklandığı zaman Backend API'nin API Tanım Belgesi görüntülenir.

<img src="/images/develop/message-processing/api-tanim-belgesi.png" alt="API Tanım Belgesi" width="800" height="auto" />

<Info>
Bu bölümde politikaların detaylarına girilmeyecektir. Politikalarla ilgili detaylı bilgi için [Politika Nedir?](/tr/concepts/temel-kavramlar/politika-nedir) sayfasına bakılabilir.
</Info>


## Request Pipeline (İstek Boru Hattı)

Request Pipeline, istemciden gelen isteklerin backend'e gönderilmeden önce işlendiği pipeline'dır.

### Request Pipeline Akışı

Request Pipeline şu aşamalardan oluşur:

1. **Pre-flow Politikaları**: Güvenlik ve doğrulama
2. **Koşullu Politikalar**: Koşullu işlemler
3. **Yönlendirme Adımı**: Backend'e yönlendirme


## Response Pipeline (Yanıt Boru Hattı)

Response Pipeline, backend'den gelen yanıtların istemciye gönderilmeden önce işlendiği pipeline'dır.

### Response Pipeline Akışı
 
Yanıt akışı şu sırayla işlenir:

1. **Post-flow Politikaları (Yanıt)**: Yanıt dönüştürme
2. **Koşullu Politikalar**: Koşullu işlemler
3. **Loglama**: İşlem kaydı (Asenkron)
4. **İstemci Yanıtı**: İstemciye yanıt

## Error Pipeline (Hata Boru Hattı)

Error Pipeline, hata durumlarının işlendiği pipeline'dır. Request veya Response pipeline'ında bir hata oluştuğunda Error Pipeline devreye girer.

### Error Pipeline Akışı
 
Hata durumunda şu akış izlenir:

1. **Fault Handler Politikaları**: Hata yakalama politikaları
2. **Hata Dönüştürme**: Hata mesajı dönüştürme
3. **Hata Loglama**: Hata kaydı
4. **Hata Yanıtı**: İstemciye hata yanıtı

### Hata Durumunda Politikaların İşletilme Sırası

Hata durumunda işletilecek olan politikalar "Hata Politikası Ekle" seçeneği ile eklenir.

Akışın herhangi bir noktasında hata olması durumunda normal akış kesilerek öncelikle varsa hata yanıt şablonu hata mesajına uygulanır.

Sonrasında "Hata Politikaları" hattına eklenen politikalar **sağdan sola doğru** sırasıyla işletilir.

## Koşullu Politika Çalıştırma

Politikalar koşullara bağlı olarak çalıştırılabilir. Koşullu politika çalıştırma, mesaj içeriğine, header değerlerine, query parametrelerine, IP adresine, zaman bazlı koşullara veya sistem değişkenlerine göre farklı politikaların uygulanmasını sağlar.

Koşullu politika çalıştırma hakkında detaylı bilgi için [Koşullu Politika Çalıştırma](/tr/concepts/temel-kavramlar/kosullu-politika-calistirma) sayfasına bakabilirsiniz.

## Politika Yönetimi

Politikalar, istek ve yanıt mesajları üzerinde gerçekleştirilmesi istenen güvenlik, mesajları filtreleme, doğrulama, dönüştürme ya da zenginleştirme, kısmen iş mantığı uygulama, hata yönetimi vb. işlemleri tarif etmek üzere yapılan konfigürasyonlardır. API Gateway, İstemci ile Backend API arasındaki mesaj akışı sırasında, bu konfigürasyonlar ile kendisine tanıtılan politikaları işletir.

<Info>
Bu bölümde genel olarak politikalar üzerinde yapılabilecek işlemler anlatılmaktadır. Herhangi bir politika hakkında detaylı bilgi edinmek için [Politika Nedir?](/tr/concepts/temel-kavramlar/politika-nedir) sayfasından ilgili politikaya ilişkin dokümantasyona bakabilirsiniz.
</Info>

### Politikaların Yeri ve Çalışma Sırası

Politikalar 3 farklı noktaya eklenebilir:

- API Proxy Grubu
- API Proxy
- Metot/Endpoint

Bir API Proxy Grubuna eklenen bir politika, sadece istek API Proxy Grup üzerinden gelmiş ise işletilir.

Bir API Proxy'ye eklenen bir politika, o API Proxy'nin bütün metot/endpoint'leri için işletilir.

Bir metot/endpoint'e eklenen bir politika, yalnızca o metot/endpoint için işletilir.

Aşağıdaki görselde bu 3 noktaya da eklenmiş olan politikalara ilişkin bir örnek bulunmaktadır.

Görselde **GET - findByStatus** adlı metot/endoint'i seçilmiş olan API Proxy'nin, **Proxy Group - 1** adlı bir API Proxy Grubu'na eklenmiş olduğu görülmektedir.

İşaretlenmiş olan alanlar, politikaların nereye eklendiğine bağlı olarak görüntülendikleri yerlerdir:

- 1 numaralı çerçeve ile işaretlenen alanda, bu API Proxy için herhangi bir metot/endpoint seçilmeden, bütün metot/endpoint'ler için geçerli olacak şekilde eklenmiş ve istek mesajlarına uygulanacak olan politikalar görülür. **Hepsi (All)** yazısı bunu ifade eder.
- 2 numaralı çerçeve ile işaretlenen alanda, seçilmiş olan metot/endpoint için geçerli olacak şekilde ve istek mesajlarına uygulanacak olan politikalar görülür.
- 3 numaralı çerçeve ile işaretlenen alanda, seçilmiş olan metot/endpoint için geçerli olacak şekilde ve yanıt mesajlarına uygulanacak olan politikalar görülür.
- 4 numaralı çerçeve ile işaretlenen alanda, bu API Proxy için herhangi bir metot/endpoint seçilmeden, bütün metot/endpoint'ler için geçerli olacak şekilde eklenmiş ve yanıt mesajlarına uygulanacak olan politikalar görülür. **Hepsi (All)** yazısı bunu ifade eder.

<img src="/images/develop/message-processing/politika-yerleri.png" alt="Politika Yerleri" width="1000" height="auto" />

<Warning>
Bu API Proxy herhangi bir API Proxy Grubuna eklenmiş, eklenen API Proxy Grupta politikalar bulunuyor ve istek API Proxy Grup üzerinden geldiyse request hattındakiler uygulanır daha sonra response hattı üzerindeki politikalar da uygulanır. Ancak bu sayfada gösterilmez.
</Warning>

API Proxy'nin herhangi bir metot/endpoint'i için herhangi bir politikanın eklenmiş olması durumunda metot/endpoint yanında çark ikonu bulunur.

Eğer API Proxy'nin belirli bir metot/endpoint'i seçilmezse (ya da **Hepsi (All)**) seçilirse, aşağıdaki görselde gösterildiği gibi 2 bölge görünür.

<img src="/images/develop/message-processing/hepsi-seceneği.png" alt="Hepsi Seçeneği" width="1000" height="auto" />

- 1 numaralı çerçeve ile işaretlenen alanda, bu API Proxy'nin bütün metot/endpoint'leri için geçerli olacak şekilde eklenmiş ve istek mesajlarına uygulanacak olan politikalar görülür.
- 2 numaralı çerçeve ile işaretlenen alanda, bu API Proxy'nin bütün metot/endpoint'leri için geçerli olacak şekilde eklenmiş ve yanıt mesajlarına uygulanacak olan politikalar görülür.

## Politikaların İşletilme Sırası

Politikalar, mesajın akış sırasında;

- İstek mesajı için API Proxy Grup → API Proxy → metot/endpoint sırasıyla
- Yanıt mesajı için metot/endpoint → API Proxy → API Proxy Grup sırasıyla

işletilir. Her seviyede, o seviyedeki politikalar mesajın akış yönündeki sıralamaya göre işleme alınır.

Aşağıdaki görselde bu durum özetlenmiş, politikaların işleme alınma sıraları numaralandırılarak gösterilmiştir.

<img src="/images/develop/message-processing/politika-isletilme-sirasi.png" alt="Politika İşletilme Sırası" width="1000" height="auto" />

### Akışa Politika Ekleme

Bir politika eklemek için:

<Steps>
<Step title="Varlık Seçimi">
Politikanın eklenmek istediği varlık seçilir. Örneğin API Proxy'nin bütün metot/endpoint'leri için uygulanması istenen bir politika için, o API Proxy'nin metot/endpoint alanında **Hepsi (All)** seçilir.
</Step>

<Step title="Politika Ekleme">
Politikanın istek mesajına mı yanıt mesajına mı ekleneceğine göre uygun alandaki **➕ Politika Ekle (Add Policy)** ikonuna tıklanır.

<img src="/images/develop/message-processing/politika-ekle.png" alt="Politika Ekle" width="800" height="auto" />
</Step>

<Step title="Politika Tipi Seçimi">
Açılan pencereden eklenmek istenen politikanın tipi seçilir. Bu pencerede görünen politika tipleri, aktif API Proxy'nin tipine ve hangi bölge politika eklenmek istendiğine göre değişir.

<img src="/images/develop/message-processing/politika-tipi-secimi.png" alt="Politika Tipi Seçimi" width="800" height="auto" />
</Step>

<Step title="Politika Konfigürasyonu">
Eklenmek istenen politika seçildiğinde, o politikaya ilişkin konfigürasyon bilgisinin girilebileceği bir pencere açılır. Bu pencereden farklı şekillerde politika eklenebilir:

1. **Var olan bir global politikayı eklemek için**: Politika penceresinde, en üstte politika tipinin yanındaki **Global Politikalardan Seç (Select From Global Policies)** bağlantısına tıklanır. Açılan pencereden uygun politika seçilerek işlem tamamlanır.

<img src="/images/develop/message-processing/global-politika-secimi.png" alt="Global Politika Seçimi" width="800" height="auto" />

2. **Yerel politika oluşturmak için**: Herhangi özel işlem yapmadan açılan pencerede girilen veriler ile yerel politika oluşturulması sağlanır.
</Step>
</Steps>

### Akıştaki Politikayı Güncelleme

Var olan bir politikanın ikonuna tıklandığı zaman, o politikanın bilgilerinin güncellenebileceği bir pencere açılır.

<img src="/images/develop/message-processing/politika-guncelleme.png" alt="Politika Güncelleme" width="800" height="auto" />

### Seçilen Politikayı Activate/Deactivate Etme

Bir politika, eklenmiş olduğu metot/endpoint ya da API Proxy'den silinmeden geçici olarak kullanımdan kaldırılabilir. Bunun için politika güncellenmek üzere açılır ve açılan pencerenin en üst kısmındaki **Deactivate** tuşuna tıklanır.

<img src="/images/develop/message-processing/politika-deactivate.png" alt="Politika Deactivate" width="800" height="auto" />

### Bütün Politikaları Activate/Deactivate Etme

Metot/endpoint bölümünde, orta bölümün alt kısmında **Bütün Politikaları Kapat (Disable All Policies)** bağlantısı belirir. Bu bağlantıya tıklandığı zaman, eğer **Hepsi (All)** seçeneğinde ise API Proxy üzerine eklenmiş olan bütün politikalar; eğer herhangi bir metot içerisindeyse sadece o metot içerisinde eklenmiş olan tüm politikalar devre dışı kalır. Kullanımdan kaldırılmış olan politikalar daha sonra politika güncelleme penceresinden tek tek ya da **Bütün Politikaları Aç (Activate All Policies)** bağlantısına tıklanarak toplu olarak yeniden etkinleştirilebilir.

<img src="/images/develop/message-processing/butun-politikalari-kapat.png" alt="Bütün Politikaları Kapat" width="800" height="auto" />

Politikalar devre dışı kaldığında, ikonların renkleri değişerek gri bir görünüme kavuşur.

<img src="/images/develop/message-processing/devre-disi-politikalar.png" alt="Devre Dışı Politikalar" width="800" height="auto" />

<Warning>
Eğer API Proxy bir API Proxy Grubu'na eklenmişse ve bu API Proxy Grubu üzerinden politikalar uygulanmışsa, bütün politikaların kapatılması API Proxy Grubu'ndan gelen politikaları etkilemez, bu politikalar aktif olarak kalır.
</Warning>

### Akıştan Politika Kaldırma

Fare silinmek istenen politikanın üzerine getirildiğinde, politikayı silecek bir ikon belirir. Bu ikona tıklanarak politika silinebilir.

<img src="/images/develop/message-processing/politika-silme.png" alt="Politika Silme" width="800" height="auto" />

<Warning>
Geliştirme sekmesinde gerçekleştirilen politika silme işleminde:

- Politika yerel ise tamamen silinir
- Politika global ise yalnızca bu metot/endpoint ya da API Proxy ile ilişkisi kaldırılır, politikanın kendisi silinmez. Daha sonra tekrar eklenebilir. Bir global politikanın tamamen silinmesi isteniyorsa, silme işleminin [Politika Yönetimi](/tr/develop/api-proxy-konfigurasyonu/politika-yonetimi) arayüzlerinden yapılması gerekir.
</Warning>

## Politika Uygulama Örnekleri

### Örnek 1: Basit Mesaj İşleme

<CardGroup cols={1}>
  <Card title="İstek" icon="arrow-right">
    GET /api/v1/products
  </Card>
  <Card title="1. Pre-flow: OAuth2 Authentication" icon="check-circle">
    ✓ Başarılı
  </Card>
  <Card title="2. Pre-flow: Rate Limiting" icon="check-circle">
    ✓ Başarılı
  </Card>
  <Card title="3. Route: Backend'e yönlendirme" icon="route">
    Backend API'ye istek gönderilir
  </Card>
  <Card title="4. Post-flow: Response Logging" icon="check-circle">
    ✓ Başarılı
  </Card>
  <Card title="Yanıt" icon="reply">
    200 OK
  </Card>
</CardGroup>

### Örnek 2: Koşullu Politika Uygulama

<CardGroup cols={1}>
  <Card title="İstek" icon="arrow-right">
    POST /api/v1/products
  </Card>
  <Card title="1. Pre-flow: OAuth2 Authentication" icon="check-circle">
    ✓ Başarılı
  </Card>
  <Card title="2. Koşullu Politika" icon="code-branch">
    Content-Type header'ına göre:<br/>
    * `application/json` ise → JSON Schema Validation ✓<br/>
    * `application/xml` ise → XML Schema Validation ✓
  </Card>
  <Card title="3. Route: Backend'e yönlendirme" icon="route">
    Backend API'ye istek gönderilir
  </Card>
  <Card title="4. Post-flow: Response Transformation" icon="check-circle">
    ✓ Başarılı
  </Card>
  <Card title="Yanıt" icon="reply">
    201 Created
  </Card>
</CardGroup>

### Örnek 3: Hata Durumunda Politika Uygulama

<CardGroup cols={1}>
  <Card title="İstek" icon="arrow-right">
    GET /api/v1/products
  </Card>
  <Card title="1. Pre-flow: OAuth2 Authentication" icon="xmark-circle">
    ✗ Token geçersiz
  </Card>
  <Card title="2. Fault Handler Policy" icon="triangle-exclamation">
    * Error Response Transformation<br/>
    * Error Logging
  </Card>
  <Card title="Yanıt" icon="reply">
    401 Unauthorized
  </Card>
</CardGroup>

## Best Practices

<AccordionGroup>
  <Accordion title="Request Pipeline">
    * Güvenlik politikalarını önce çalıştırın
    * Ağır işlemleri sona bırakın
    * Validation'ı transformation'dan önce yapın
    * Koşullu politikaları optimize edin
  </Accordion>
  
  <Accordion title="Response Pipeline">
    * Data masking'i önce yapın
    * Transformation'ı sonra yapın
    * Logging'i en sona bırakın
    * Performansı göz önünde bulundurun
  </Accordion>
  
  <Accordion title="Error Pipeline">
    * Tüm hataları yakalayın
    * Kullanıcı dostu hata mesajları oluşturun
    * Hassas bilgileri maskeleyin
    * Detaylı loglama yapın
  </Accordion>
</AccordionGroup>

## Sonraki Adımlar

<CardGroup cols={2}>
  <Card title="Politika Nedir?" icon="shield" href="/tr/concepts/temel-kavramlar/politika-nedir">
    Politika kavramını öğrenin
  </Card>
  <Card title="Routing ve Upstream" icon="route" href="/tr/concepts/temel-kavramlar/routing-ve-upstream">
    Routing ve Upstream kavramlarını öğrenin
  </Card>
  <Card title="Koşullu Politika Çalıştırma" icon="code-branch" href="/tr/concepts/temel-kavramlar/kosullu-politika-calistirma">
    Koşullu politika çalıştırmayı öğrenin
  </Card>
</CardGroup>

