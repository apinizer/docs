---
title: "Trace loglarını tutan koleksiyonların temizlenmesi"
description: 'Trace loglarını tutan koleksiyonların temizlenmesi'
---

*   *   *   *   * 

  * [Apinizer Dokümantasyonu](/apinizer-dokumantasyonu/apinizer-dokuemantasyonuna-hos-geldiniz-1179695.html)
  * [Bakım İşlemleri](/apinizer-dokumantasyonu/bakim-islemleri-39732228.html)
  * [Veritabanı Büyümesinin Kontrol Altında Tutulması](/apinizer-dokumantasyonu/veritabani-bueyuemesinin-kontrol-altinda-tutulmasi-75806320.html)
  * Current: Trace loglarını tutan koleksiyonların temizlenmesi

# Trace loglarını tutan koleksiyonların temizlenmesi

Trace'in açık olduğu durumda; ``log_apiproxytraffic,`` `log_apiproxytraffic_policy_execution, `log_apiproxytraffic_routing` `isimli koleksiyonlar API trafiğinin detaylarını kaydeder. Trace kapatıldıktan sonra bile bu veriler veritabanında tutulmaya devam edilir. Bu kayıtlar sayesinde trace ekranında, ilgili proxy'deki politika(lar) uygulanmadan önce ve sonra ne durumda olduğu, trafik bilgileri ve yönlendirme bilgileri incelenebilir.

  

**Kayıt Temizleme Scripti:**

Aşağıdaki script, MongoDB'deki ``log_apiproxytraffic, ```log_apiproxytraffic_policy_execution, `log_apiproxytraffic_routing`` koleksiyonlarında depolanan uygulama loglarından belirtilen saat öncesine kadar olan kayıtları silmek için kullanılır.

Bu işlem ile veritabanı temizlenerek depolama alanı optimize edilmiş olunur.

```bash

    #!/bin/bash
    
    # MongoDB sunucusuna bağlanmak için gerekli bilgiler
    HOST="<MONGODB_MASTER_IP_ADDRESS>"
    PORT="<MONGODB_PORT>"
    DB_NAME="apinizerdb"
    USERNAME="apinizer"
    PASSWORD="<PASSWORD>"
    AUTH_DB="admin"
    TARGET_COLLECTIONS=("log_apiproxytraffic_policy_execution" "log_apiproxytraffic" "log_apiproxytraffic_routing")
    TARGET_LOG_LOCATION=$(pwd)/purge_trace_logs.log
    
    echo "Script started on $(date +"%Y-%m-%d %H:%M:%S")" >> $TARGET_LOG_LOCATION  
    
    # Son kaç saat/gün öncesine kadar olan belgelerin silineceğini belirten değişken
    TIME_VALUE="1D"  #Bu değeri istediğiniz gibi değiştirebilirsiniz.
    
    QUERY_CONDITION=""
    
    # TIME_VALUE değerini analiz edip milisaniye cinsinden dönüştürme 
    if [[ ! -z $TIME_VALUE ]]; then
        if [[ $TIME_VALUE =~ [Hh]$ ]]; then
            HOURS_AGO=${TIME_VALUE%H*}
            TIME_IN_MILLISECONDS=$(($HOURS_AGO * 60 * 60 * 1000))
            QUERY_CONDITION="\"timestamp\": {\"\$lt\": new Date((new Date().getTime() - $TIME_IN_MILLISECONDS))}"
        elif [[ $TIME_VALUE =~ [Dd]$ ]]; then
            DAYS_AGO=${TIME_VALUE%D*}
            TIME_IN_MILLISECONDS=$(($DAYS_AGO * 24 * 60 * 60 * 1000))
            QUERY_CONDITION="\"timestamp\": {\"\$lt\": new Date((new Date().getTime() - $TIME_IN_MILLISECONDS))}"
        else             
    		echo "Invalid time format. Please enter a value ending with H (hour) or D (day)." >> $TARGET_LOG_LOCATION
             exit 1
        fi
    fi
    
    if [[ -z $QUERY_CONDITION ]]; then
        echo "TIME_VALUE is not valid." >> $TARGET_LOG_LOCATION
        exit 1
    fi
    
    for COLLECTION in "${TARGET_COLLECTIONS[@]}"; do
    MONGO_COMMANDS=$(cat <<<EOF
    var bulk = db.getCollection("$COLLECTION").initializeUnorderedBulkOp();
    bulk.find({$QUERY_CONDITION}).remove();
    bulk.execute();
    EOF
    )
    
    	# Komutu çalıştır ve çıktısını log dosyasına yazdır
    	{
            mongosh mongodb://$USERNAME:$PASSWORD@$HOST:$PORT/$DB_NAME --authenticationDatabase $AUTH_DB --eval "$MONGO_COMMANDS"
            # Komutun tamamlanmasını kontrol et
            if [ $? -ne 0 ]; then
                echo "MongoDB command for collection $COLLECTION failed." >> $TARGET_LOG_LOCATION
                exit 1
            fi
        } >> $TARGET_LOG_LOCATION 2>&1
    done  
    
    echo "The command has been executed. Please check the content of the related collection." >> $TARGET_LOG_LOCATION
     
    echo "Script finished on $(date +"%Y-%m-%d %H:%M:%S")" >> $TARGET_LOG_LOCATION
```


![](/apinizer-dokumantasyonu/_/05BD9F48017A5D1E2319A7812864C3E5/1699865923290/images/common/warning-macro-icon.svg)

Zaman filtresi UTC'e göre yapılmaktadır.

### Nasıl Çalışır:

  1. MongoDB sunucusuna bağlanmak için gerekli bilgiler ilgili değişkenlere tanımlanır: HOST, PORT, DB_NAME, USERNAME, PASSWORD ve AUTH_DB.
  2. TIME_VALUE değişkeni ile son kaç saat öncesine kadar olan kayıtların silineceği belirtilir. Bu değer saat (H) veya gün (D) cinsinden olabilir.
  3. `MONGO_COMMANDS` değişkeni içerisinde, belirtilen saat öncesine kadar olan belgeleri bulmak ve silmek için MongoDB komutları tanımlanır.
  4. `mongosh` komutu ile MongoDB sunucusuna bağlanılır ve `MONGO_COMMANDS` değişkeninde tanımlanan komutlar çalıştırılır.
  5. İşlem tamamlandığında, ekrana "`The command has been executed. Please check the content of the related collection.`" mesajı yazdırılır.

### Kullanım:

  * Scripti çalıştırmadan önce MongoDB değişkenlerine kendi bilgilerinizi giriniz, TIME_VALUE değişkenini istediğiniz saat/gün değerine göre güncelleyebilirsiniz. Örneğin, son 3 saatteki belgeleri korumak ve geri kalanını silmek için TIME_VALUE=3H, son 5 gündeki belgeleri korumak ve geri kalanını silmek için TIME_VALUE=5D olarak ayarlayabilirsiniz.
  * Scripti Linux tabanlı bir işletim sisteminde çalıştırmak için öncelikle bir metin düzenleyici (vi, nano vb.) yardımıyla script bir dosyaya kopyalanır ve içindeki değişkenler düzenlenir.
  * Dosyaya çalıştırma yetkisi verilir: `chmod +x purge_trace_logs.sh`
  * Dosya çalıştırılır: `./purge_trace_logs.sh` Uzun sürecek bir işlem yapacağınızı düşünüyorsanız komut sonuna boşluk bırakıp `&` karakterini ekleyerek arkaplanda çalışmasını sağlayabilirsiniz: `./purge_trace_logs.sh &`

  

```bash
    chmod +x /path/to/purge_trace_logs.sh
    ./path/to/purge_trace_logs.sh &
```


  

Bu işlem manuel yapılabileceği gibi belirli aralıklarda tekrarlanarak da yapılabilir. Tekrarlanarak yapılması için linux cronjob ayarlarına bu kaydın girilmesi gerekir.

### CronJob Kullanım:

1) Terminalde aşağıdaki komutu çalıştırarak cron düzenleyicisi açılır:
```bash
    crontab -e
```


  

2) Açılan editöre, scripti ne sıklıkla çalıştırmak istediğinize göre bir satır ekleyin.

Örneğin, her gün saat 23:59'da çalıştırmak için aşağıdaki şekilde yazabilirsiniz:
```bash
    59 23 * * * /path/to/purge_trace_logs.sh > /path/to/logfile.log 2>&1
```


Eklediğiniz satırı kaydetmek için Esc tuşuna basıp :wq yazıp enter tuşuna basın.

  

![](/apinizer-dokumantasyonu/_/05BD9F48017A5D1E2319A7812864C3E5/1699865923290/images/common/info-macro-icon.svg)

Hatırlatma

Script içerisinde belirttiğiniz zaman dilimine göre veri temizleme işlemi gerçekleşecektir.

Bu nedenle, script içerisindeki zaman diliminin ve cron ile belirlediğiniz tetikleme saatinin tutarlı olmasını sağlamak önemlidir.

×