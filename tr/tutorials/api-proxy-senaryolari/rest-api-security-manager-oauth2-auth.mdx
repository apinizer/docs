---
title: REST API'ye Security Manager Provider Aracılığıyla OAuth2 Authentication Poliçesinin Uygulanması
description: "Swagger Petstore REST API'sine Security Manager provider aracılığıyla OAuth2 Authentication poliçesinin nasıl uygulanacağını açıklar. Credential oluşturulmasından politikasının eklenmesine, token oluşturulmasından test edilmesine kadar tüm adımları içerir."
---

Aşağıdaki grafikte yer alan numaralandırmalar işlemlerin **yapılış sırasına aittir.**

- **Apinizer** içerisinde yer alan **Security Manager, API Client'tan OAuth2 türünde authentication** bilgisini ister. Bu authentication doğru ise akış devam eder.
- **Apinizer, Backend API'ye istekte** bulunur.
- **Backend API, Apinizer'a** yanıt verir.
- **Apinizer, API Client'a** yanıt verir.
<img src="/images/tutorials/oauth1.png" alt="Senaryo Diyagramı" width="800" />
## API Proxy'nin Oluşturulması

<img src="/images/tutorials/senaryo2.png" alt="Senaryo Diyagramı" width="200" />

Swagger Petstore isimli REST API'ye [https://petstore.swagger.io/](https://petstore.swagger.io/) adresinden erişim sağlanabilmektedir.

İlk olarak bu adresin **API Proxy** olarak tanımlanması gereklidir.

Bunun için **Development** menüsü altında yer alan **API Proxies** seçeneğine tıklanır.

<Info>
  Açılan sayfada daha önceden herhangi bir **proxy** tanımı yapılmadığı için **No records found!** yazısı yer alır.
</Info>

Sağ üst köşede yer almakta olan **Create** butonuna tıklanır ve yeni bir **proxy** oluşturulmaya başlanır.
<img src="/images/tutorials/senaryo3.png" alt="Senaryo Diyagramı" width="800" />

Bu kısımda oluşturulacak olan **API Proxy'nin** hangi tipte olduğunun seçilmesi gerekmektedir.

Bu senaryoda kullanılacak olan API'nin türü **Swagger 2.X** olacağı için bu tür seçilir.

**Enter URL** ifadesine tıklanarak kullanılacak olan API'nin adresinin girileceği ekrana geçiş yapılır.
<img src="/images/tutorials/swagger.png" alt="Senaryo Diyagramı" width="800" />

URL kısmına **erişim sağlanacak adres girilerek Parse** butonuna tıklanır.
<img src="/images/tutorials/senaryo5.png" alt="Senaryo Diyagramı" width="800" />

Parse işlemi yapıldıktan sonra API Proxy'ye ait ayarlar yapılabilmektedir:

- **Usage** alanı ile oluşturulan API Proxy'nin kim tarafından kullanılacağı belirtilir. Burada **publisher, consumer, publisher and consumer** gibi seçenekler yer almaktadır.
- **Sharing Type** alanı ile oluşturulan API Proxy'nin paylaşım tipi belirtilir. Burada **external, internal, external and internal** gibi seçenekler yer almaktadır.
- **Addresses** sekmesi altında yer alan iki API adresinden biri veya her ikisi de seçilebilir eğer iki adres de seçilecek olursa Apinizer **Load Balance** işlemini kendisi gerçekleştirecektir.
- **Relative Path** ise oluşturulan API Proxy'nin erişime açılacak adresidir.
- **Category List** alanı da oluşturulan API Proxy'nin kategorilendirilmesine olanak sağlar.

<img src="/images/tutorials/senaryo6.png" alt="Senaryo Diyagramı" width="800" />


Bu ayarlamalar yapıldıktan sonra API Proxy kaydedilir.

Kaydetme işleminden sonra açılan sayfada **Develop** sekmesine tıklanır.
<img src="/images/tutorials/senaryo7.png" alt="Senaryo Diyagramı" width="800" />


<Info>
  Bu endpointlerin üstünde yer alan **All** ifadesiyle eklenecek olan poliçeler **tüm endpointlere** uygulanabilmektedir.
</Info>

Oluşturulan API Proxy deploy edilir. Bunun için yukarıda orta kısımda yer alan **Deploy** butonuna tıklanır.
<img src="/images/tutorials/senaryo8.png" alt="Senaryo Diyagramı" width="800" />

## Credentials Oluşturulması

Eklenecek **Credentials'a** ait bilgiler **username = apinizer**, **password = 123123aA** olacak şekildedir.

Bunun için **Identity Management** menüsüne gelinir.

Burada ise **Credential Management** menüsü altında yer alan **Credentials** menüsüne tıklanır.
<img src="/images/tutorials/senaryo9.png" alt="Senaryo Diyagramı" width="200" />


Açılan ekranda sağ üst köşede yer alan **Create** butonuna tıklanır.
<img src="/images/tutorials/senaryo10.png" alt="Senaryo Diyagramı" width="600" />

Burada gerekli olan alanlar daha önceden belirtilen şekilde doldurulur ve **Save and Deploy** butonuna tıklayarak oluşturulan **credential** kaydedilir.
<img src="/images/tutorials/senaryo11.png" alt="Senaryo Diyagramı" width="800" />

Bu **credential öğesinin** erişim sağlayacağı proxy'nin seçilmesi gerekmektedir. Oluşturulan **credential'ın** üzerine gelip yanda yer alan menüden **Edit** seçeneğine tıklanır.
<img src="/images/tutorials/senaryo12.png" alt="Senaryo Diyagramı" width="800" />

Açılan ekran üzerinden **API Proxy ACL** sekmesine tıklanır, bu sekme içerisinde yer alan butona tıklanır.
<img src="/images/tutorials/api-proxy-acl.png" alt="Senaryo Diyagramı" width="800" />


Açılan sayfada şu an üzerinde çalışılan projede bulunan **API Proxy'ler** listelenmektedir. **Swagger Petstore** isimli **proxy** seçilir.

**Add** butonuna tıklayarak oluşturulan **Credential** öğesinin bu **proxy'ye erişimi olacağı belirtilir.**
<img src="/images/tutorials/senaryo14.png" alt="Senaryo Diyagramı" width="600" />

Sağ üst köşede yer alan **Save and Deploy** butonuna tıklanır ve yapılan işlem kaydedilir.
<img src="/images/tutorials/save.png" alt="Senaryo Diyagramı" width="600" />

## Authentication Poliçesinin Eklenmesi

Artık **OAuth2 Authentication** poliçesi eklenebilir duruma gelmiştir.

API proxy'lerin listelendiği sayfaya gidilir ve buradan **Swagger Petstore** isimli proxy seçilir.

Daha sonra ise **Develop** sekmesine gelinir, **Add Policy** butonuna tıklanır.

Açılan sayfada **OAuth2 Authentication** poliçesi seçilir.
<img src="/images/tutorials/oauth2.png" alt="Senaryo Diyagramı" width="800" />

Bu ekran üzerinde yer alan alanlar:

- **Grant Type** alanı ile kullanılacak **token servisinin** kullanıcı bilgilerinin nasıl doğrulanacağı belirtilir eğer **Client Credentials** ifadesi seçilirse **(Identity/Role/Group) Service** kullanılamaz.
- **Show API Key** alanı ile oluşturulan proxy'ye ait **API proxy key** değerleri gözükmektedir.
- **Delete Previous Token** alanı ile daha önceden bulunan token geçersiz hale getirir.
- **Token Never Expires** alanı ile oluşturulan token'a bir zaman değeri atanmaz ve istenildiği kadar kullanılabilir bu seçenek seçilmez ise hemen altında aşağıdaki görselde yer alan bir menü oluşur.
- **Token Expires In** alanı ile token'ın ne kadar bir süre geçerli olacağı belirtilir, bu belirtme işlemi açılır menü içerisinde yer alan zaman ifadeleri ile ayarlanabilir.
- **Refresh Token Allowed** alanı ile oluşturulan token'ın yenilenme özelliği aktifleştirilir. Bu seçenek seçildiği takdirde de kaç kez yenilenebileceğine dair ayarlamanın yapılacağı alan gelmektedir ve bu alana ait görsel aşağıda yer almaktadır.
- **Refresh Token Count** token'ın kaç kez yenilenebilir olacağını belirtir.
- **Refresh Token Expires In** alanı ise yenilenen token'ın ne kadarlık bir yaşam süresine sahip olacağını belirtir.
- **Allow URL Parameters** alanı ile token üretimi için istek gönderildiğinde gidecek olan bilgilerin sadece mesaj gövdesinde gönderilmesine izin verilir. Eğer bu bilgilerin "URL Parametresi" olarak gönderilmesi istenirse bu seçenek seçilmelidir ancak bu durum bir güvenlik riski oluşturacağı için önerilmez.
<Warning>
  **Clear Authentication Information** alanı ile backend API'ye gidecek mesaj içerisinde herhangi bir kimlik doğrulama bilgisi varsa bu bilgiler silinir ve **backend API'ye** gönderilmez. Bu ayarın aktifleştirilmesi özel bir durum olmadığı sürece her zaman tavsiye edilmektedir.
</Warning>

- **Add Client Info to Header** alanı ile kimlik doğrulama başarılı bir şekilde gerçekleştiğinde, yetkilendirilmiş olan kullanıcı adını header'ın içine koyarak backend API'ye gönderir. Bu seçenek işaretlendiğinde ise hemen altında içerisinde **X-Authenticated-UserId** yazan bir input alanı oluşacaktır. Bu alan header bilgisinin varsayılan adıdır.
<img src="/images/tutorials/oauth3.png" alt="Senaryo Diyagramı" width="800" />

Bu senaryo içerisinde kullanılacak olan ayarlamalar yapıldıktan sonra sağ üst köşede yer alan **Save** butonuna tıklanır.
<img src="/images/tutorials/oauth4.png" alt="Senaryo Diyagramı" width="800" />


Yapılan işlemin geçerli olması için proxy'nin **Deploy** olması gerekmektedir.

## Authentication İçin Token Oluşturulması

OAuth2 Authentication poliçesi içerisinde yer alan **Show API Key** seçeneğinden ilgili proxy'ye ait Public Key bilgisi alınır.
<img src="/images/tutorials/token1.png" alt="Senaryo Diyagramı" width="400" />


Daha sonra ise **Test** menüsü altında yer alan **Test Console** menüsüne gelinir.
<img src="/images/tutorials/token2.png" alt="Senaryo Diyagramı" width="200" />


Bu ekrana geldikten sonra ise **Collection** sekmesi altında yer alan **New** butonuna tıklanır ve yeni bir **Collection** oluşturulur.

**Name** alanına **OAuth2** yazılır ve **Save** butonuna tıklanır.
<img src="/images/tutorials/oauth5.png" alt="Senaryo Diyagramı" width="400" />

Bu ekran üzerinde yer alan ifadeler tek tek incelenecek olursa,

- **Method** alanından method tipi seçilir.
- URL alanına token'ın alınacağı adres yazılır.
- Mesajın içeriği **body** kısmında yer alacağı için aşağıda yer alan sekmeden **body** ifadesi seçilir.
- Buraya token elde edebilmek için gerekli olan değerler yazılır ve **Send** butonuna tıklanır.

<img src="/images/tutorials/oauth6.png" alt="Senaryo Diyagramı" width="800" />


Yanıt içerisinde yer alan **access_token** bilgisi **OAuth2 Authentication** poliçesi oluşturulan proxy'de kullanmak için oluşturulmuştur.

Bu token kopyalanır.

Tekrardan API proxy'nin olduğu sayfaya geçiş yapılır.
<img src="/images/tutorials/oauth7.png" alt="Senaryo Diyagramı" width="800" />

## API Proxy'nin Test Edilmesi

**Swagger Petstore** isimli proxy seçilir.

**Develop** sekmesi altında yer alan **"/pet/{petId}"** isimli endpoint seçilir.

**Test Endpoint** ifadesine tıklanarak bu endpoint test edilir.


URL'de istenilen **petId** değeri **"1"** olarak girilir, **Send** butonuna basıldığında dönen yanıtın bir hata mesajı olduğu görülür.
<img src="/images/tutorials/oauth8.png" alt="Senaryo Diyagramı" width="800" />

<Warning>
  Bu hatanın uygulanmış olan **OAuth2 Authentication** ile alakalı olduğu görülmektedir. Çünkü **header'ın** içerisine hiçbir şekilde bir **authentication** bilgisi yerleştirilmemiştir.
</Warning>

Bu sefer **header** içerisine **Authorization header** yerleştirilir ve elde edilen **token bilgisi** burada kullanılır.

**Send** butonuna tıkladığında başarılı cevap alınır.
<img src="/images/tutorials/oauth9.png" alt="Senaryo Diyagramı" width="800" />
